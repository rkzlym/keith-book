<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql 调优 | 鸿鹄笔记</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" content="/favicon.ico">
    <meta name="description" content="鸿鹄的个人笔记">
    <meta rel="author" content="Keith">
    
    <link rel="preload" href="/keith-book/assets/css/0.styles.86c07c9d.css" as="style"><link rel="preload" href="/keith-book/assets/js/app.7ae60ab7.js" as="script"><link rel="preload" href="/keith-book/assets/js/2.044773f5.js" as="script"><link rel="preload" href="/keith-book/assets/js/56.ab84e214.js" as="script"><link rel="prefetch" href="/keith-book/assets/js/10.13f771ae.js"><link rel="prefetch" href="/keith-book/assets/js/100.af11b532.js"><link rel="prefetch" href="/keith-book/assets/js/101.b5e393e3.js"><link rel="prefetch" href="/keith-book/assets/js/102.7a7d2386.js"><link rel="prefetch" href="/keith-book/assets/js/103.4b5c8925.js"><link rel="prefetch" href="/keith-book/assets/js/104.8c63d13c.js"><link rel="prefetch" href="/keith-book/assets/js/105.2bfbf884.js"><link rel="prefetch" href="/keith-book/assets/js/106.47faa20d.js"><link rel="prefetch" href="/keith-book/assets/js/107.9ad2a314.js"><link rel="prefetch" href="/keith-book/assets/js/108.008b5fa7.js"><link rel="prefetch" href="/keith-book/assets/js/109.62761423.js"><link rel="prefetch" href="/keith-book/assets/js/11.a6a3b5c9.js"><link rel="prefetch" href="/keith-book/assets/js/110.8afb8e61.js"><link rel="prefetch" href="/keith-book/assets/js/111.57012fed.js"><link rel="prefetch" href="/keith-book/assets/js/112.535b424f.js"><link rel="prefetch" href="/keith-book/assets/js/113.c23530b0.js"><link rel="prefetch" href="/keith-book/assets/js/114.834b12cd.js"><link rel="prefetch" href="/keith-book/assets/js/115.ce1b3169.js"><link rel="prefetch" href="/keith-book/assets/js/116.65b1520c.js"><link rel="prefetch" href="/keith-book/assets/js/117.fd80cfe9.js"><link rel="prefetch" href="/keith-book/assets/js/118.f05a98aa.js"><link rel="prefetch" href="/keith-book/assets/js/119.4cea8196.js"><link rel="prefetch" href="/keith-book/assets/js/12.42246af7.js"><link rel="prefetch" href="/keith-book/assets/js/120.275abc51.js"><link rel="prefetch" href="/keith-book/assets/js/121.0a4ec53d.js"><link rel="prefetch" href="/keith-book/assets/js/122.aebc3a0f.js"><link rel="prefetch" href="/keith-book/assets/js/123.a9c61bf2.js"><link rel="prefetch" href="/keith-book/assets/js/124.54f656c9.js"><link rel="prefetch" href="/keith-book/assets/js/125.554faf7e.js"><link rel="prefetch" href="/keith-book/assets/js/126.88f70416.js"><link rel="prefetch" href="/keith-book/assets/js/127.7aeb22c3.js"><link rel="prefetch" href="/keith-book/assets/js/128.5e8f8a6c.js"><link rel="prefetch" href="/keith-book/assets/js/129.d96c386d.js"><link rel="prefetch" href="/keith-book/assets/js/13.614d862e.js"><link rel="prefetch" href="/keith-book/assets/js/14.d938dc50.js"><link rel="prefetch" href="/keith-book/assets/js/15.27956206.js"><link rel="prefetch" href="/keith-book/assets/js/16.8259d213.js"><link rel="prefetch" href="/keith-book/assets/js/17.59fccf41.js"><link rel="prefetch" href="/keith-book/assets/js/18.1ae9a1fd.js"><link rel="prefetch" href="/keith-book/assets/js/19.3f56180c.js"><link rel="prefetch" href="/keith-book/assets/js/20.a6a8e2d9.js"><link rel="prefetch" href="/keith-book/assets/js/21.fa3c5532.js"><link rel="prefetch" href="/keith-book/assets/js/22.8c3384e6.js"><link rel="prefetch" href="/keith-book/assets/js/23.8ea8dbc6.js"><link rel="prefetch" href="/keith-book/assets/js/24.d65bce25.js"><link rel="prefetch" href="/keith-book/assets/js/25.b2d0686f.js"><link rel="prefetch" href="/keith-book/assets/js/26.fdc5f5b5.js"><link rel="prefetch" href="/keith-book/assets/js/27.8bb47b1d.js"><link rel="prefetch" href="/keith-book/assets/js/28.e087e2b0.js"><link rel="prefetch" href="/keith-book/assets/js/29.4306565c.js"><link rel="prefetch" href="/keith-book/assets/js/3.83866d44.js"><link rel="prefetch" href="/keith-book/assets/js/30.92b9c15a.js"><link rel="prefetch" href="/keith-book/assets/js/31.a231c5d0.js"><link rel="prefetch" href="/keith-book/assets/js/32.30b3c540.js"><link rel="prefetch" href="/keith-book/assets/js/33.d4ae83e5.js"><link rel="prefetch" href="/keith-book/assets/js/34.2d831459.js"><link rel="prefetch" href="/keith-book/assets/js/35.fd638673.js"><link rel="prefetch" href="/keith-book/assets/js/36.a936bf23.js"><link rel="prefetch" href="/keith-book/assets/js/37.f0a03b08.js"><link rel="prefetch" href="/keith-book/assets/js/38.635b6ac3.js"><link rel="prefetch" href="/keith-book/assets/js/39.dc3d7a09.js"><link rel="prefetch" href="/keith-book/assets/js/4.e2dc8d0c.js"><link rel="prefetch" href="/keith-book/assets/js/40.06264354.js"><link rel="prefetch" href="/keith-book/assets/js/41.a5492cc2.js"><link rel="prefetch" href="/keith-book/assets/js/42.be57bef1.js"><link rel="prefetch" href="/keith-book/assets/js/43.88a27c79.js"><link rel="prefetch" href="/keith-book/assets/js/44.c4499e0a.js"><link rel="prefetch" href="/keith-book/assets/js/45.bc3d4bb0.js"><link rel="prefetch" href="/keith-book/assets/js/46.77fe74ff.js"><link rel="prefetch" href="/keith-book/assets/js/47.a6d9e6fb.js"><link rel="prefetch" href="/keith-book/assets/js/48.aef4698e.js"><link rel="prefetch" href="/keith-book/assets/js/49.a0d6928f.js"><link rel="prefetch" href="/keith-book/assets/js/5.281837e2.js"><link rel="prefetch" href="/keith-book/assets/js/50.97367378.js"><link rel="prefetch" href="/keith-book/assets/js/51.5aa97e63.js"><link rel="prefetch" href="/keith-book/assets/js/52.c8645f8c.js"><link rel="prefetch" href="/keith-book/assets/js/53.ddb048d3.js"><link rel="prefetch" href="/keith-book/assets/js/54.4b3240ad.js"><link rel="prefetch" href="/keith-book/assets/js/55.906f19b3.js"><link rel="prefetch" href="/keith-book/assets/js/57.4b0773ba.js"><link rel="prefetch" href="/keith-book/assets/js/58.ba67fb3c.js"><link rel="prefetch" href="/keith-book/assets/js/59.c70cec7d.js"><link rel="prefetch" href="/keith-book/assets/js/6.a3b769ae.js"><link rel="prefetch" href="/keith-book/assets/js/60.328ff957.js"><link rel="prefetch" href="/keith-book/assets/js/61.821c95c9.js"><link rel="prefetch" href="/keith-book/assets/js/62.a8706fa5.js"><link rel="prefetch" href="/keith-book/assets/js/63.7893739a.js"><link rel="prefetch" href="/keith-book/assets/js/64.e0e82da5.js"><link rel="prefetch" href="/keith-book/assets/js/65.c8630545.js"><link rel="prefetch" href="/keith-book/assets/js/66.71acb88b.js"><link rel="prefetch" href="/keith-book/assets/js/67.1d69d8ae.js"><link rel="prefetch" href="/keith-book/assets/js/68.cbcd16b5.js"><link rel="prefetch" href="/keith-book/assets/js/69.7ad720f1.js"><link rel="prefetch" href="/keith-book/assets/js/7.4d8a2bf7.js"><link rel="prefetch" href="/keith-book/assets/js/70.94b0ffc1.js"><link rel="prefetch" href="/keith-book/assets/js/71.f82c5f63.js"><link rel="prefetch" href="/keith-book/assets/js/72.bc8c9c4e.js"><link rel="prefetch" href="/keith-book/assets/js/73.0705a1c5.js"><link rel="prefetch" href="/keith-book/assets/js/74.5f096bb0.js"><link rel="prefetch" href="/keith-book/assets/js/75.3f8747a5.js"><link rel="prefetch" href="/keith-book/assets/js/76.651eb39a.js"><link rel="prefetch" href="/keith-book/assets/js/77.f999879e.js"><link rel="prefetch" href="/keith-book/assets/js/78.61f7757f.js"><link rel="prefetch" href="/keith-book/assets/js/79.8bd2dd06.js"><link rel="prefetch" href="/keith-book/assets/js/8.d352d476.js"><link rel="prefetch" href="/keith-book/assets/js/80.b123974d.js"><link rel="prefetch" href="/keith-book/assets/js/81.2009dcf1.js"><link rel="prefetch" href="/keith-book/assets/js/82.29cd7333.js"><link rel="prefetch" href="/keith-book/assets/js/83.936db179.js"><link rel="prefetch" href="/keith-book/assets/js/84.bc885c59.js"><link rel="prefetch" href="/keith-book/assets/js/85.d4e8c66d.js"><link rel="prefetch" href="/keith-book/assets/js/86.7cc46a2b.js"><link rel="prefetch" href="/keith-book/assets/js/87.2c8ce44d.js"><link rel="prefetch" href="/keith-book/assets/js/88.bb2c361f.js"><link rel="prefetch" href="/keith-book/assets/js/89.9a1ee5e4.js"><link rel="prefetch" href="/keith-book/assets/js/9.29357314.js"><link rel="prefetch" href="/keith-book/assets/js/90.aa69ffbe.js"><link rel="prefetch" href="/keith-book/assets/js/91.a8944021.js"><link rel="prefetch" href="/keith-book/assets/js/92.cd8a456d.js"><link rel="prefetch" href="/keith-book/assets/js/93.0b16e3c6.js"><link rel="prefetch" href="/keith-book/assets/js/94.d8822045.js"><link rel="prefetch" href="/keith-book/assets/js/95.fa963ca4.js"><link rel="prefetch" href="/keith-book/assets/js/96.c4728133.js"><link rel="prefetch" href="/keith-book/assets/js/97.f29d3516.js"><link rel="prefetch" href="/keith-book/assets/js/98.64cb768c.js"><link rel="prefetch" href="/keith-book/assets/js/99.7f8d1f38.js">
    <link rel="stylesheet" href="/keith-book/assets/css/0.styles.86c07c9d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/keith-book/" class="home-link router-link-active"><img src="/keith-book/favicon.ico" alt="鸿鹄笔记" class="logo"> <span class="site-name can-hide">鸿鹄笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/mysql/" class="sidebar-heading clickable open"><span>mysql</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/mysql/mysql基础.html" class="sidebar-link">mysql 基础</a></li><li><a href="/keith-book/数据存储/mysql/mysql事务.html" class="sidebar-link">mysql 事务</a></li><li><a href="/keith-book/数据存储/mysql/mysql索引.html" class="sidebar-link">mysql 索引</a></li><li><a href="/keith-book/数据存储/mysql/mysql锁.html" class="sidebar-link">mysql 锁</a></li><li><a href="/keith-book/数据存储/mysql/mysql主从复制.html" class="sidebar-link">mysql 主从复制</a></li><li><a href="/keith-book/数据存储/mysql/mysql调优.html" class="active sidebar-link">mysql 调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql调优.html#常用指令" class="sidebar-link">常用指令</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql调优.html#数据类型优化" class="sidebar-link">数据类型优化</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql调优.html#查询优化" class="sidebar-link">查询优化</a></li></ul></li><li><a href="/keith-book/数据存储/mysql/mysql分区表.html" class="sidebar-link">mysql分区表</a></li><li><a href="/keith-book/数据存储/mysql/mysql服务器参数配置.html" class="sidebar-link">mysql 服务器参数设置</a></li><li><a href="/keith-book/数据存储/mysql/mysql分库分表.html" class="sidebar-link">mysql 分库分表</a></li><li><a href="/keith-book/数据存储/mysql/SQL执行底层原理.html" class="sidebar-link">SQL 执行底层原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/redis/" class="sidebar-heading clickable"><span>redis</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/redis/redis基础.html" class="sidebar-link">redis基础</a></li><li><a href="/keith-book/数据存储/redis/redis命令速查.html" class="sidebar-link">redis命令速查</a></li><li><a href="/keith-book/数据存储/redis/redis常见缓存问题.html" class="sidebar-link">redis常见缓存问题</a></li><li><a href="/keith-book/数据存储/redis/redis配置.html" class="sidebar-link">redis配置文件</a></li><li><a href="/keith-book/数据存储/redis/redis线程模型.html" class="sidebar-link">redis线程模型</a></li><li><a href="/keith-book/数据存储/redis/redis事务.html" class="sidebar-link">redis事务</a></li><li><a href="/keith-book/数据存储/redis/redis过期策略.html" class="sidebar-link">redis过期策略</a></li><li><a href="/keith-book/数据存储/redis/redis分布式锁.html" class="sidebar-link">redis分布式锁</a></li><li><a href="/keith-book/数据存储/redis/redis集群.html" class="sidebar-link">redis集群</a></li><li><a href="/keith-book/数据存储/redis/redis主从复制.html" class="sidebar-link">redis主从复制</a></li><li><a href="/keith-book/数据存储/redis/redis持久化.html" class="sidebar-link">redis持久化</a></li><li><a href="/keith-book/数据存储/redis/redis漏斗算法.html" class="sidebar-link">redis漏斗算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/mq/" class="sidebar-heading clickable"><span>mq</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/mq/RabbitMQ基础.html" class="sidebar-link">RabbitMQ基础</a></li><li><a href="/keith-book/数据存储/mq/RabbitMQ高级.html" class="sidebar-link">RabbitMQ高级</a></li><li><a href="/keith-book/数据存储/mq/RabbitMQ应用.html" class="sidebar-link">RabbitMQ应用</a></li></ul></section></li><li><a href="/keith-book/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/elasticsearch/" class="sidebar-link">elasticsearch</a></li><li><a href="/keith-book/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/mongodb/" class="sidebar-link">mongodb</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-调优"><a href="#mysql-调优" class="header-anchor">#</a> mysql 调优</h1> <p>导入mysql官方案例数据库 https://dev.mysql.com/doc/index-other.html</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql -u root -p

mysql<span class="token operator">&gt;</span>source /sakila-db/sakila-schema.sql
mysql<span class="token operator">&gt;</span>source /sakila-db/sakila-data.sql
</code></pre></div><h2 id="常用指令"><a href="#常用指令" class="header-anchor">#</a> 常用指令</h2> <h3 id="slow-query-log"><a href="#slow-query-log" class="header-anchor">#</a> slow query log</h3> <blockquote><p>慢查询日志</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 查看是否开启慢查询日志</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%slow_query_log%'</span>
<span class="token comment">-- 开启和关闭 (1和0)，数据库关闭失效</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 查看多少时间算慢查询，默认10秒</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%long_query_time%'</span><span class="token punctuation">;</span>
<span class="token comment">-- 设置慢查询的阈值</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="show-profile"><a href="#show-profile" class="header-anchor">#</a> show profile</h3> <blockquote><p>是mysql提供可以用来分析当前会话中的语句执行的资源消耗情况，可以用于sql调优的测量</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 查看profile是否开启，默认关闭</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'profiling'</span><span class="token punctuation">;</span>
<span class="token comment">-- 打开profile</span>
<span class="token keyword">set</span> profiling <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询profiles</span>
<span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
<span class="token comment">-- 查询详情</span>
<span class="token keyword">show</span> profile cpu<span class="token punctuation">,</span> block io <span class="token keyword">for</span> query <span class="token punctuation">[</span>Query_ID<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="执行计划-explain"><a href="#执行计划-explain" class="header-anchor">#</a> 执行计划 explain</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">--- Explain查询结果字段说明 ---</span>
id: id越大，优先级越高；id相同，执行顺序由上至下
select_type: 查询类型，主要用于区别普通查询、联合查询、子查询等
<span class="token keyword">table</span>: 查询的表
partitions: 分区
<span class="token keyword">type</span>: 访问类型
possible_keys: 查询涉及到的字段若存在索引，将被列出，但不一定被实际使用
<span class="token keyword">key</span>: 实际使用的索引，如为<span class="token boolean">NULL</span>，则没使用索引。查询中若使用了覆盖索引，则该索引仅出现在<span class="token keyword">key</span>列表中
key_len: 索引的长度
ref: 显示索引的哪一列被使用了
<span class="token keyword">rows</span>: 根据表统计信息索引选用的情况，大致估算出找出所需的记录需要读取的行数
extra: 额外信息

<span class="token comment">--- type (至少要达到range) ---</span>
system: 表中只有一行记录，可忽略不计
const: 一次就检索到，主键或唯一索引比较常量
eq_ref: 唯一性索引扫描，表中只有一条记录与之匹配，常见于主键或唯一索引扫描
ref: 非唯一性索引扫描，返回匹配某个单独值的所有行
range: 只检索给定范围的行，<span class="token keyword">where</span>子句中出现<span class="token operator">&lt;</span>、<span class="token operator">&gt;</span>、<span class="token operator">between</span>、<span class="token operator">in</span>等查询
<span class="token keyword">index</span>: 全索引扫描
<span class="token keyword">all</span>: 全表扫描

<span class="token comment">--- extra ---</span>
<span class="token keyword">Using</span> filesort: 无法利用索引进行排序，只能利用排序算法，会消耗额外的位置
<span class="token keyword">Using</span> <span class="token keyword">temporary</span>: 建立临时表来保存中间结果，查询完成后把临时表删除
<span class="token keyword">Using</span> <span class="token keyword">Index</span>: 当前查询有覆盖索引的，直接从索引中取数据，不访问数据表
<span class="token keyword">Using</span> <span class="token keyword">where</span>: 使用了<span class="token keyword">where</span>查询
<span class="token keyword">Using</span> <span class="token keyword">join</span> buffer: 使用了连接缓存
impossible <span class="token keyword">where</span>: <span class="token keyword">where</span>子句的结果是<span class="token boolean">false</span>
<span class="token keyword">select</span> <span class="token keyword">tables</span> optimized away: 在没有<span class="token keyword">group</span> <span class="token keyword">by</span>子句的情况下，基于索引优化MIN<span class="token operator">/</span>MAX操作
<span class="token keyword">distinct</span>: 优化<span class="token keyword">distinct</span>操作，在找到第一匹配元组后即停止找同样值的动作
</code></pre></div><h2 id="数据类型优化"><a href="#数据类型优化" class="header-anchor">#</a> 数据类型优化</h2> <h3 id="数据类型设计原则"><a href="#数据类型设计原则" class="header-anchor">#</a> 数据类型设计原则</h3> <ol><li><p>使用可以正确存储数据的最小数据类型</p> <p>更小数据类型更快，因为它们占用更少的磁盘、内存和CPU缓存，并且处理时需要的CPU周期更少</p></li> <li><p>简单数据类型的操作通常需要更少的CPU周期</p> <ol><li>整型比字符操作代价更低，因为字符集和校对规则是字符比较比整型比较更复杂</li> <li>使用mysql自建类型而不是字符串来存储日期和时间</li> <li>用整型存储IP地址</li></ol></li> <li><p>查询条件中避免包含可为NULL的列</p> <p>mysql难以优化查询中包含可为 NULL 的列，因为可为 NULL 的列使得索引、索引统计和值比较变得更加复杂</p></li></ol> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <ol><li><p>整型：尽量使用满足需求的最小数据类型</p> <p>TINYINT 8位，SMALLINT 16位，MEDIUMINT 24位，INT 32位，BIGINT 64位</p></li> <li><p>字符和字符串类型</p> <ol><li><p>varchar：根据实际内容长度保存数据</p> <p>varchar(n) n小于等于255使用额外一个字节保存长度，n&gt;255使用额外两个字节保存长度</p> <p>varchar(5)与varchar(255)保存同样的内容，硬盘存储空间相同，但内存空间占用不同，是指定的大小</p></li> <li><p>char固定长度的字符串</p> <p>最大长度为255，会自动删除末尾的空格。检索和写效率都比varchar高，以空间换时间​</p></li></ol></li> <li><p>BLOB 和 TEXT 类型</p> <p>MySQL 把每个 BLOB 和 TEXT 值当作一个独立的对象处理</p> <p>两者都是为了存储很大数据而设计的字符串类型，分别采用二进制和字符方式存储</p></li> <li><p>日期类型：不要使用字符串存储日期类型，占用空间大，损失日期类型函数的便捷性</p> <ol><li>datetime：8字节，与时区无关，数据库底层时区配置对datetime无效，可保存到毫秒，可保存时间范围大</li> <li>timestamp：4字节，范围：1970-01-01到2038-01-19，采用整形存储，依赖数据库设置的时区自动更新timestamp列的值</li> <li>date：3字节，范围 1000-01-01~9999-12-31，可以利用日期时间函数进行日期之间的计算</li></ol></li></ol> <h3 id="枚举代替字符串类型"><a href="#枚举代替字符串类型" class="header-anchor">#</a> 枚举代替字符串类型</h3> <p>有时可以使用枚举类代替常用的字符串类型，mysql存储枚举类型会非常紧凑，会根据列表值的数据压缩到一个或两个字节中，mysql在内部会将每个值在列表中的位置保存为整数，并且在表的.frm文件中保存“数字-字符串”映射关系的查找表</p> <div class="language-mysql extra-class"><pre class="language-text"><code>create table enum_test(e enum('fish','apple','dog') not null);
insert into enum_test(e) values('fish'),('dog'),('apple');
select e+0 from enum_test;
</code></pre></div><h3 id="特殊类型数据"><a href="#特殊类型数据" class="header-anchor">#</a> 特殊类型数据</h3> <p>人们经常使用varchar(15)来存储ip地址，然而，它的本质是32位无符号整数不是字符串，可以使用INET_ATON()和INET_NTOA函数在这两种表示方法之间转换</p> <div class="language-mysql extra-class"><pre class="language-text"><code>select inet_aton('1.1.1.1')
select inet_ntoa(16843009)
</code></pre></div><h2 id="查询优化"><a href="#查询优化" class="header-anchor">#</a> 查询优化</h2> <h3 id="优化细节"><a href="#优化细节" class="header-anchor">#</a> 优化细节</h3> <ol><li>当使用索引列进行查询的时候尽量不要使用表达式</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> actor_id <span class="token keyword">from</span> actor <span class="token keyword">where</span> actor_id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> actor_id <span class="token keyword">from</span> actor <span class="token keyword">where</span> actor_id<span class="token operator">+</span><span class="token number">1</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li><p>尽量使用主键查询，因为主键查询不会触发回表查询</p></li> <li><p>使用前缀索引：取一个字符串的前几个字节作为索引，节约存储空间</p> <p>对于 BLOB, TEXT, VARCHAR 类型的列必须要使用前缀索引，因为 mysql 不允许索引这些列的完整长度</p> <p>mysql 无法使用前缀索引做 order by 和 group by</p></li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 索引的选择性越高则查询效率越高</span>
<span class="token comment">-- 索引的选择性 = 不重复的索引值 / 数据表记录总数</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel3<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel4<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel5<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel6<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel7<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">left</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sel8 
<span class="token keyword">from</span> citydemo<span class="token punctuation">;</span>
<span class="token comment">-- 根据前面测试创建前缀索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> citydemo <span class="token keyword">add</span> <span class="token keyword">key</span><span class="token punctuation">(</span>city<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li><p>索引排序：explain 出来的 type 列的值为 index ，说明 mysql 使用了索引扫描做排序</p> <p>在使用排序的时候，如果 where 和 order by 中的列能组成一个最左前缀匹配，就会使用索引排序</p></li> <li><p>union all,in,or都能够使用索引，但是推荐使用in</p></li> <li><p>范围列可以用到索引，但是范围列后面的列无法用到索引，索引最多用于一个范围列</p></li> <li><p>强制类型转换会全表扫描</p></li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 不会触发索引</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> phone<span class="token operator">=</span><span class="token number">13800001234</span><span class="token punctuation">;</span>
<span class="token comment">-- 触发索引</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> phone<span class="token operator">=</span><span class="token string">'13800001234'</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li><p>当需要进行表连接的时候，最好不要超过三张表，因为需要 join 的字段，数据类型必须一致</p></li> <li><p>能使用limit的时候尽量使用limit</p></li> <li><p>单表索引建议控制在5个以内，单索引字段数不允许超过5个（组合索引）</p></li></ol> <h3 id="查询性能低下原因"><a href="#查询性能低下原因" class="header-anchor">#</a> 查询性能低下原因</h3> <blockquote><p>网络、CPU、IO、上下文切换、系统调用、生成统计信息、锁等待时间</p></blockquote> <p>查询性能低下的主要原因：某些查询需要筛选大量的数据，可以通过减少访问数据量进行优化</p> <ol><li><p>查询不需要的记录：查询时要在后面添加 <code>limit</code></p></li> <li><p>多表关联时返回全部列</p></li> <li><p>总是取出全部列 <code>select *</code></p></li> <li><p>重复查询相同的数据：需重复执行返回相同数据的查询，可以使用缓存</p></li></ol> <h3 id="执行过程的优化"><a href="#执行过程的优化" class="header-anchor">#</a> 执行过程的优化</h3> <h4 id="查询优化处理"><a href="#查询优化处理" class="header-anchor">#</a> 查询优化处理</h4> <ol><li><p>语法解析器和预处理</p> <p>mysql通过关键字将SQL语句进行解析，并生成一颗解析树，mysql解析器将使用mysql语法规则验证和解析查询，例如验证使用使用了错误的关键字或者顺序是否正确等等，预处理器会进一步检查解析树是否合法，例如表名和列名是否存在，是否有歧义，还会验证权限等等</p></li> <li><p>查询优化器</p></li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> film_actor<span class="token punctuation">;</span>
<span class="token comment">-- 可以看到上面这条查询语句需要经过多少个数据页才能找到对应的数据（基于成本）</span>
<span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'last_query_cost'</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>mysql可能会选择错误的执行计划 原因如下</strong></p> <ol><li><p>统计信息不准确：InnoDB因为其mvcc的架构，并不能维护一个数据表的行数的精确统计信息</p></li> <li><p>执行计划的成本估算不等同于实际执行的成本：有时候某个执行计划虽然需要读取更多的页面，但是他的成本却更小，因为如果这些页面都是顺序读或者这些页面都已经在内存中的话，那么它的访问成本将很小，mysql层面并不知道哪些页面在内存中，哪些在磁盘，所以查询之际执行过程中到底需要多少次IO是无法得知的</p></li> <li><p>mysql的优化是基于成本模型的优化，但是有可能不是最快的优化</p></li> <li><p>mysql不考虑其他并发执行的查询</p></li> <li><p>mysql不会考虑不受其控制的操作成本</p></li> <li><p>执行存储过程或者用户自定义函数的成本</p></li></ol> <h4 id="优化器的优化策略"><a href="#优化器的优化策略" class="header-anchor">#</a> 优化器的优化策略</h4> <ol><li><p>静态优化：直接对解析树进行分析，并完成优化</p></li> <li><p>动态优化：动态优化与查询的上下文有关，也可能跟取值、索引对应的行数有关</p></li></ol> <p>mysql对查询的静态优化只需要一次，但对动态优化在每次执行时都需要重新评估</p> <h4 id="优化器的优化类型"><a href="#优化器的优化类型" class="header-anchor">#</a> 优化器的优化类型</h4> <ol><li><p>重新定义关联表的顺序：数据表的关联并不总是按照在查询中指定的顺序进行。将外连接转化成内连接，内连接的效率要高于外连接，使用等价变换规则，mysql可以使用一些等价变化来简化并规划表达式</p></li> <li><p>min max：使用min max的时候，使用 group by 条件，这样可以使用索引</p></li> <li><p>索引覆盖扫描：当索引中的列包含所有查询中需要使用的列的时候，可以使用覆盖索引</p></li> <li><p>等值传播： 如果两个列的值通过等式关联，那么mysql能够把其中一个列的where条件传递到另一个上</p></li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 这两个SQL执行效率是一样的</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> film<span class="token punctuation">.</span>film_id <span class="token keyword">from</span> film <span class="token keyword">inner</span> <span class="token keyword">join</span> film_actor 
<span class="token keyword">using</span><span class="token punctuation">(</span>film_id<span class="token punctuation">)</span> <span class="token keyword">where</span> film<span class="token punctuation">.</span>film_id <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">;</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> film<span class="token punctuation">.</span>film_id <span class="token keyword">from</span> film <span class="token keyword">inner</span> <span class="token keyword">join</span> film_actor 
<span class="token keyword">using</span><span class="token punctuation">(</span>film_id<span class="token punctuation">)</span> <span class="token keyword">where</span> film<span class="token punctuation">.</span>film_id <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token operator">and</span> film_actor<span class="token punctuation">.</span>film_id <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="优化子查询"><a href="#优化子查询" class="header-anchor">#</a> 优化子查询</h4> <p>子查询尽可能使用关联查询代替，因为子查询产生的临时表数据集多，产生额外的IO</p> <h4 id="优化排序"><a href="#优化排序" class="header-anchor">#</a> 优化排序</h4> <p>排序的算法：</p> <ol><li><p>两次传输排序：第一次数据读取是将需要排序的字段读取出来，然后进行排序，第二次是将排好序的结果按照需要去读取数据行</p> <p>缺点：需要进行两次IO，效率较低</p></li> <li><p>单次传输排序：先读取查询所需要的所有列，然后再根据给定列进行排序，最后直接返回排序结</p> <p>缺点：在查询的列特别多的时候，会占用大量的存储空间，无法存储大量的数据</p></li></ol> <p><strong>优化策略</strong></p> <p>当需要排序的列的总大小超过 max_length_for_sort_data 定义的字节，mysql 会选择双次排序，反之使用单次排序，当然，用户可以设置此参数的值来选择排序的方式</p> <h4 id="优化count查询"><a href="#优化count查询" class="header-anchor">#</a> 优化count查询</h4> <p>总有人认为myisam的count函数比较快，这是有前提条件的，只有没有任何where条件的count才是比较快的</p> <p><strong>使用近似值</strong></p> <p>在某些应用场景中，不需要完全精确的值，可以参考使用近似值来代替，比如可以使用explain来获取近似的值</p> <p>其实在很多OLAP的应用中，需要计算某一个列值的基数，有一个计算近似值的算法叫hyperloglog。</p> <p><strong>更复杂的优化</strong></p> <p>一般情况下，count()需要扫描大量的行才能获取精确的数据，其实很难优化，在实际操作的时候可以考虑使用索引覆盖扫描，或者增加汇总表，或者增加外部缓存系统。</p> <h4 id="优化关联查询"><a href="#优化关联查询" class="header-anchor">#</a> 优化关联查询</h4> <p>join的实现方式原理</p> <p><img src="https://img-blog.csdnimg.cn/20210122101434106.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <ol><li>Join Buffer会缓存所有参与查询的列而不是只有Join的列。</li> <li>可以通过调整join_buffer_size缓存大小，默认值是256K</li> <li>使用Block Nested-Loop Join算法需要开启优化器管理配置的optimizer_switch的设置block_nested_loop为on，默认为开启。</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%optimizer_switch%'</span>
</code></pre></div><p><strong>join on and 解释</strong></p> <p>两张表匹配的时候，如果使用 and ，那么最终结果集中未被 and 匹配上的记录会展示为 NULL</p> <p>举例1：假如是左连接，那么下面第一行返回的结果集的基础上，再将 e.age &lt;= 20的 d 表的记录置为NULL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">join</span> dep d <span class="token keyword">on</span> e<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>id 
<span class="token operator">and</span> e<span class="token punctuation">.</span>age <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
</code></pre></div><p>举例2：左表记录都存在，右表记录都是NULL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">join</span> dep d <span class="token keyword">on</span> <span class="token number">1</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>优化策略</strong></p> <ol><li><p>确保 on 或者 using 子句中的列上有索引</p></li> <li><p>一般情况下来说，只需要在关联顺序中的第二个表的相应列上创建索引</p></li> <li><p>确保任何的 group by 和 order by 中的表达式只涉及到一个表中的列，这样mysql才有可能使用索引来优化这个过程</p></li> <li><p>优化子查询：子查询的优化最重要的优化建议是尽可能使用关联查询代替</p></li> <li><p>尽可能减少Join语句中NestedLoop的循环总次数，用小结果集驱动大结果集。</p></li> <li><p>确保Join语句中被驱动表上的Join条件字段已经被索引。</p></li></ol> <h4 id="优化limit分页"><a href="#优化limit分页" class="header-anchor">#</a> 优化limit分页</h4> <blockquote><p>在很多应用场景中我们需要将数据进行分页，一般会使用limit加上偏移量的方法实现，同时加上合适的order by 的子句，如果这种方式有索引的帮助，效率通常不错，否则的化需要进行大量的文件排序操作，还有一种情况，当偏移量非常大的时候，前面的大部分数据都会被抛弃，这样的代价太高。</p></blockquote> <p>要优化这种查询的话，要么是在页面中限制分页的数量，要么优化大偏移量的性能</p> <p>优化此类查询的最简单的办法就是尽可能地使用覆盖索引，而不是查询所有的列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 查看执行计划查看扫描的行数</span>
<span class="token comment">-- 1000行</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> film_id<span class="token punctuation">,</span>description <span class="token keyword">from</span> film <span class="token keyword">order</span> <span class="token keyword">by</span> title <span class="token keyword">limit</span> <span class="token number">50</span><span class="token punctuation">,</span><span class="token number">5</span>
<span class="token comment">-- 55+1+55 行</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> film<span class="token punctuation">.</span>film_id<span class="token punctuation">,</span>film<span class="token punctuation">.</span>description <span class="token keyword">from</span> film <span class="token keyword">inner</span> <span class="token keyword">join</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> film_id <span class="token keyword">from</span> film <span class="token keyword">order</span> <span class="token keyword">by</span> title <span class="token keyword">limit</span> <span class="token number">50</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lim <span class="token keyword">using</span><span class="token punctuation">(</span>film_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="优化union查询"><a href="#优化union查询" class="header-anchor">#</a> 优化union查询</h4> <blockquote><p>mysql总是通过创建并填充临时表的方式来执行union查询，因此很多优化策略在union查询中都没法很好的使用。经常需要手工的将where、limit、order by等子句下推到各个子查询中，以便优化器可以充分利用这些条件进行优化</p></blockquote> <p>除非确实需要服务器消除重复的行，否则一定要使用union all，因此没有all关键字，mysql会在查询的时候给临时表加上distinct的关键字，这个操作的代价很高</p> <h4 id="推荐使用用户自定义变量"><a href="#推荐使用用户自定义变量" class="header-anchor">#</a> 推荐使用用户自定义变量</h4> <p><strong>自定义变量的使用</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> <span class="token variable">@one</span> :<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">set</span> <span class="token variable">@min_actor</span> :<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>actor_id<span class="token punctuation">)</span> <span class="token keyword">from</span> actor<span class="token punctuation">)</span>
<span class="token keyword">set</span> <span class="token variable">@last_week</span> :<span class="token operator">=</span><span class="token keyword">current_date</span><span class="token operator">-</span><span class="token keyword">interval</span> <span class="token number">1</span> week<span class="token punctuation">;</span>
</code></pre></div><p><strong>自定义变量的限制</strong></p> <ol><li>无法使用查询缓存</li> <li>不能在使用常量或者标识符的地方使用自定义变量，例如表名、列名或者limit子句</li> <li>用户自定义变量的生命周期是在一个连接中有效，所以不能用它们来做连接间的通信</li> <li>不能显式地声明自定义变量地类型</li> <li>mysql优化器在某些场景下可能会将这些变量优化掉，这可能导致代码不按预想地方式运行</li> <li>赋值符号：=的优先级非常低，所以在使用赋值表达式的时候应该明确的使用括号</li> <li>使用未定义变量不会产生任何语法错误</li></ol> <p><strong>自定义变量的使用案例</strong></p> <p>优化排名语句</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 在给一个变量赋值的同时使用这个变量</span>
<span class="token keyword">select</span> actor_id<span class="token punctuation">,</span><span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token variable">@rownum</span><span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">as</span> rownum <span class="token keyword">from</span> actor <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询获取演过最多电影的前10名演员，然后根据出演电影次数做一个排名</span>
<span class="token keyword">select</span> actor_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> film_actor <span class="token keyword">group</span> <span class="token keyword">by</span> actor_id <span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">-- 避免重新查询刚刚更新的数据</span>
<span class="token comment">-- 当需要高效的更新一条记录的时间戳，同时希望查询当前记录中存放的时间戳是什么</span>
<span class="token keyword">update</span> t1 <span class="token keyword">set</span>  lastUpdated<span class="token operator">=</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> id <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> lastUpdated <span class="token keyword">from</span> t1 <span class="token keyword">where</span> id <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t1 <span class="token keyword">set</span> lastupdated <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token variable">@now</span>:<span class="token operator">=</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@now</span><span class="token punctuation">;</span>
<span class="token comment">-- 确定取值的顺序</span>
<span class="token comment">-- 在赋值和读取变量的时候可能是在查询的不同阶段</span>
<span class="token keyword">set</span> <span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> actor_id<span class="token punctuation">,</span><span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token variable">@rownum</span><span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> actor <span class="token keyword">where</span> <span class="token variable">@rownum</span><span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 因为where和select在查询的不同阶段执行，所以看到查询到两条记录，这不符合预期</span>
<span class="token keyword">set</span> <span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> actor_id<span class="token punctuation">,</span><span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token variable">@rownum</span><span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> actor <span class="token keyword">where</span> <span class="token variable">@rownum</span><span class="token operator">&lt;=</span><span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> first_name
<span class="token comment">-- 当引入了order by之后，发现打印出了全部结果，这是因为order by引入了文件排序，而where条件是在文件排序操作之前取值的  </span>
<span class="token comment">-- 解决这个问题的关键在于让变量的赋值和取值发生在执行查询的同一阶段：</span>
<span class="token keyword">set</span> <span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> actor_id<span class="token punctuation">,</span><span class="token variable">@rownum</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> actor <span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token variable">@rownum</span>:<span class="token operator">=</span><span class="token variable">@rownum</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/21/2021, 11:41:55 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/keith-book/数据存储/mysql/mysql主从复制.html" class="prev">
        mysql 主从复制
      </a></span> <span class="next"><a href="/keith-book/数据存储/mysql/mysql分区表.html">
        mysql分区表
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/keith-book/assets/js/app.7ae60ab7.js" defer></script><script src="/keith-book/assets/js/2.044773f5.js" defer></script><script src="/keith-book/assets/js/56.ab84e214.js" defer></script>
  </body>
</html>
