<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql 事务 | 鸿鹄笔记</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" content="/favicon.ico">
    <meta name="description" content="鸿鹄的个人笔记">
    <meta rel="author" content="Keith">
    
    <link rel="preload" href="/keith-book/assets/css/0.styles.86c07c9d.css" as="style"><link rel="preload" href="/keith-book/assets/js/app.7ae60ab7.js" as="script"><link rel="preload" href="/keith-book/assets/js/2.044773f5.js" as="script"><link rel="preload" href="/keith-book/assets/js/50.97367378.js" as="script"><link rel="prefetch" href="/keith-book/assets/js/10.13f771ae.js"><link rel="prefetch" href="/keith-book/assets/js/100.af11b532.js"><link rel="prefetch" href="/keith-book/assets/js/101.b5e393e3.js"><link rel="prefetch" href="/keith-book/assets/js/102.7a7d2386.js"><link rel="prefetch" href="/keith-book/assets/js/103.4b5c8925.js"><link rel="prefetch" href="/keith-book/assets/js/104.8c63d13c.js"><link rel="prefetch" href="/keith-book/assets/js/105.2bfbf884.js"><link rel="prefetch" href="/keith-book/assets/js/106.47faa20d.js"><link rel="prefetch" href="/keith-book/assets/js/107.9ad2a314.js"><link rel="prefetch" href="/keith-book/assets/js/108.008b5fa7.js"><link rel="prefetch" href="/keith-book/assets/js/109.62761423.js"><link rel="prefetch" href="/keith-book/assets/js/11.a6a3b5c9.js"><link rel="prefetch" href="/keith-book/assets/js/110.8afb8e61.js"><link rel="prefetch" href="/keith-book/assets/js/111.57012fed.js"><link rel="prefetch" href="/keith-book/assets/js/112.535b424f.js"><link rel="prefetch" href="/keith-book/assets/js/113.c23530b0.js"><link rel="prefetch" href="/keith-book/assets/js/114.834b12cd.js"><link rel="prefetch" href="/keith-book/assets/js/115.ce1b3169.js"><link rel="prefetch" href="/keith-book/assets/js/116.65b1520c.js"><link rel="prefetch" href="/keith-book/assets/js/117.fd80cfe9.js"><link rel="prefetch" href="/keith-book/assets/js/118.f05a98aa.js"><link rel="prefetch" href="/keith-book/assets/js/119.4cea8196.js"><link rel="prefetch" href="/keith-book/assets/js/12.42246af7.js"><link rel="prefetch" href="/keith-book/assets/js/120.275abc51.js"><link rel="prefetch" href="/keith-book/assets/js/121.0a4ec53d.js"><link rel="prefetch" href="/keith-book/assets/js/122.aebc3a0f.js"><link rel="prefetch" href="/keith-book/assets/js/123.a9c61bf2.js"><link rel="prefetch" href="/keith-book/assets/js/124.54f656c9.js"><link rel="prefetch" href="/keith-book/assets/js/125.554faf7e.js"><link rel="prefetch" href="/keith-book/assets/js/126.88f70416.js"><link rel="prefetch" href="/keith-book/assets/js/127.7aeb22c3.js"><link rel="prefetch" href="/keith-book/assets/js/128.5e8f8a6c.js"><link rel="prefetch" href="/keith-book/assets/js/129.d96c386d.js"><link rel="prefetch" href="/keith-book/assets/js/13.614d862e.js"><link rel="prefetch" href="/keith-book/assets/js/14.d938dc50.js"><link rel="prefetch" href="/keith-book/assets/js/15.27956206.js"><link rel="prefetch" href="/keith-book/assets/js/16.8259d213.js"><link rel="prefetch" href="/keith-book/assets/js/17.59fccf41.js"><link rel="prefetch" href="/keith-book/assets/js/18.1ae9a1fd.js"><link rel="prefetch" href="/keith-book/assets/js/19.3f56180c.js"><link rel="prefetch" href="/keith-book/assets/js/20.a6a8e2d9.js"><link rel="prefetch" href="/keith-book/assets/js/21.fa3c5532.js"><link rel="prefetch" href="/keith-book/assets/js/22.8c3384e6.js"><link rel="prefetch" href="/keith-book/assets/js/23.8ea8dbc6.js"><link rel="prefetch" href="/keith-book/assets/js/24.d65bce25.js"><link rel="prefetch" href="/keith-book/assets/js/25.b2d0686f.js"><link rel="prefetch" href="/keith-book/assets/js/26.fdc5f5b5.js"><link rel="prefetch" href="/keith-book/assets/js/27.8bb47b1d.js"><link rel="prefetch" href="/keith-book/assets/js/28.e087e2b0.js"><link rel="prefetch" href="/keith-book/assets/js/29.4306565c.js"><link rel="prefetch" href="/keith-book/assets/js/3.83866d44.js"><link rel="prefetch" href="/keith-book/assets/js/30.92b9c15a.js"><link rel="prefetch" href="/keith-book/assets/js/31.a231c5d0.js"><link rel="prefetch" href="/keith-book/assets/js/32.30b3c540.js"><link rel="prefetch" href="/keith-book/assets/js/33.d4ae83e5.js"><link rel="prefetch" href="/keith-book/assets/js/34.2d831459.js"><link rel="prefetch" href="/keith-book/assets/js/35.fd638673.js"><link rel="prefetch" href="/keith-book/assets/js/36.a936bf23.js"><link rel="prefetch" href="/keith-book/assets/js/37.f0a03b08.js"><link rel="prefetch" href="/keith-book/assets/js/38.635b6ac3.js"><link rel="prefetch" href="/keith-book/assets/js/39.dc3d7a09.js"><link rel="prefetch" href="/keith-book/assets/js/4.e2dc8d0c.js"><link rel="prefetch" href="/keith-book/assets/js/40.06264354.js"><link rel="prefetch" href="/keith-book/assets/js/41.a5492cc2.js"><link rel="prefetch" href="/keith-book/assets/js/42.be57bef1.js"><link rel="prefetch" href="/keith-book/assets/js/43.88a27c79.js"><link rel="prefetch" href="/keith-book/assets/js/44.c4499e0a.js"><link rel="prefetch" href="/keith-book/assets/js/45.bc3d4bb0.js"><link rel="prefetch" href="/keith-book/assets/js/46.77fe74ff.js"><link rel="prefetch" href="/keith-book/assets/js/47.a6d9e6fb.js"><link rel="prefetch" href="/keith-book/assets/js/48.aef4698e.js"><link rel="prefetch" href="/keith-book/assets/js/49.a0d6928f.js"><link rel="prefetch" href="/keith-book/assets/js/5.281837e2.js"><link rel="prefetch" href="/keith-book/assets/js/51.5aa97e63.js"><link rel="prefetch" href="/keith-book/assets/js/52.c8645f8c.js"><link rel="prefetch" href="/keith-book/assets/js/53.ddb048d3.js"><link rel="prefetch" href="/keith-book/assets/js/54.4b3240ad.js"><link rel="prefetch" href="/keith-book/assets/js/55.906f19b3.js"><link rel="prefetch" href="/keith-book/assets/js/56.ab84e214.js"><link rel="prefetch" href="/keith-book/assets/js/57.4b0773ba.js"><link rel="prefetch" href="/keith-book/assets/js/58.ba67fb3c.js"><link rel="prefetch" href="/keith-book/assets/js/59.c70cec7d.js"><link rel="prefetch" href="/keith-book/assets/js/6.a3b769ae.js"><link rel="prefetch" href="/keith-book/assets/js/60.328ff957.js"><link rel="prefetch" href="/keith-book/assets/js/61.821c95c9.js"><link rel="prefetch" href="/keith-book/assets/js/62.a8706fa5.js"><link rel="prefetch" href="/keith-book/assets/js/63.7893739a.js"><link rel="prefetch" href="/keith-book/assets/js/64.e0e82da5.js"><link rel="prefetch" href="/keith-book/assets/js/65.c8630545.js"><link rel="prefetch" href="/keith-book/assets/js/66.71acb88b.js"><link rel="prefetch" href="/keith-book/assets/js/67.1d69d8ae.js"><link rel="prefetch" href="/keith-book/assets/js/68.cbcd16b5.js"><link rel="prefetch" href="/keith-book/assets/js/69.7ad720f1.js"><link rel="prefetch" href="/keith-book/assets/js/7.4d8a2bf7.js"><link rel="prefetch" href="/keith-book/assets/js/70.94b0ffc1.js"><link rel="prefetch" href="/keith-book/assets/js/71.f82c5f63.js"><link rel="prefetch" href="/keith-book/assets/js/72.bc8c9c4e.js"><link rel="prefetch" href="/keith-book/assets/js/73.0705a1c5.js"><link rel="prefetch" href="/keith-book/assets/js/74.5f096bb0.js"><link rel="prefetch" href="/keith-book/assets/js/75.3f8747a5.js"><link rel="prefetch" href="/keith-book/assets/js/76.651eb39a.js"><link rel="prefetch" href="/keith-book/assets/js/77.f999879e.js"><link rel="prefetch" href="/keith-book/assets/js/78.61f7757f.js"><link rel="prefetch" href="/keith-book/assets/js/79.8bd2dd06.js"><link rel="prefetch" href="/keith-book/assets/js/8.d352d476.js"><link rel="prefetch" href="/keith-book/assets/js/80.b123974d.js"><link rel="prefetch" href="/keith-book/assets/js/81.2009dcf1.js"><link rel="prefetch" href="/keith-book/assets/js/82.29cd7333.js"><link rel="prefetch" href="/keith-book/assets/js/83.936db179.js"><link rel="prefetch" href="/keith-book/assets/js/84.bc885c59.js"><link rel="prefetch" href="/keith-book/assets/js/85.d4e8c66d.js"><link rel="prefetch" href="/keith-book/assets/js/86.7cc46a2b.js"><link rel="prefetch" href="/keith-book/assets/js/87.2c8ce44d.js"><link rel="prefetch" href="/keith-book/assets/js/88.bb2c361f.js"><link rel="prefetch" href="/keith-book/assets/js/89.9a1ee5e4.js"><link rel="prefetch" href="/keith-book/assets/js/9.29357314.js"><link rel="prefetch" href="/keith-book/assets/js/90.aa69ffbe.js"><link rel="prefetch" href="/keith-book/assets/js/91.a8944021.js"><link rel="prefetch" href="/keith-book/assets/js/92.cd8a456d.js"><link rel="prefetch" href="/keith-book/assets/js/93.0b16e3c6.js"><link rel="prefetch" href="/keith-book/assets/js/94.d8822045.js"><link rel="prefetch" href="/keith-book/assets/js/95.fa963ca4.js"><link rel="prefetch" href="/keith-book/assets/js/96.c4728133.js"><link rel="prefetch" href="/keith-book/assets/js/97.f29d3516.js"><link rel="prefetch" href="/keith-book/assets/js/98.64cb768c.js"><link rel="prefetch" href="/keith-book/assets/js/99.7f8d1f38.js">
    <link rel="stylesheet" href="/keith-book/assets/css/0.styles.86c07c9d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/keith-book/" class="home-link router-link-active"><img src="/keith-book/favicon.ico" alt="鸿鹄笔记" class="logo"> <span class="site-name can-hide">鸿鹄笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/mysql/" class="sidebar-heading clickable open"><span>mysql</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/mysql/mysql基础.html" class="sidebar-link">mysql 基础</a></li><li><a href="/keith-book/数据存储/mysql/mysql事务.html" class="active sidebar-link">mysql 事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql事务.html#acid" class="sidebar-link">ACID</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql事务.html#事务操作" class="sidebar-link">事务操作</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql事务.html#事务并发性问题" class="sidebar-link">事务并发性问题</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql事务.html#mysql提供的4种隔离级别" class="sidebar-link">Mysql提供的4种隔离级别</a></li><li class="sidebar-sub-header"><a href="/keith-book/数据存储/mysql/mysql事务.html#mvcc-多版本并发控制" class="sidebar-link">MVCC 多版本并发控制</a></li></ul></li><li><a href="/keith-book/数据存储/mysql/mysql索引.html" class="sidebar-link">mysql 索引</a></li><li><a href="/keith-book/数据存储/mysql/mysql锁.html" class="sidebar-link">mysql 锁</a></li><li><a href="/keith-book/数据存储/mysql/mysql主从复制.html" class="sidebar-link">mysql 主从复制</a></li><li><a href="/keith-book/数据存储/mysql/mysql调优.html" class="sidebar-link">mysql 调优</a></li><li><a href="/keith-book/数据存储/mysql/mysql分区表.html" class="sidebar-link">mysql分区表</a></li><li><a href="/keith-book/数据存储/mysql/mysql服务器参数配置.html" class="sidebar-link">mysql 服务器参数设置</a></li><li><a href="/keith-book/数据存储/mysql/mysql分库分表.html" class="sidebar-link">mysql 分库分表</a></li><li><a href="/keith-book/数据存储/mysql/SQL执行底层原理.html" class="sidebar-link">SQL 执行底层原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/redis/" class="sidebar-heading clickable"><span>redis</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/redis/redis基础.html" class="sidebar-link">redis基础</a></li><li><a href="/keith-book/数据存储/redis/redis命令速查.html" class="sidebar-link">redis命令速查</a></li><li><a href="/keith-book/数据存储/redis/redis常见缓存问题.html" class="sidebar-link">redis常见缓存问题</a></li><li><a href="/keith-book/数据存储/redis/redis配置.html" class="sidebar-link">redis配置文件</a></li><li><a href="/keith-book/数据存储/redis/redis线程模型.html" class="sidebar-link">redis线程模型</a></li><li><a href="/keith-book/数据存储/redis/redis事务.html" class="sidebar-link">redis事务</a></li><li><a href="/keith-book/数据存储/redis/redis过期策略.html" class="sidebar-link">redis过期策略</a></li><li><a href="/keith-book/数据存储/redis/redis分布式锁.html" class="sidebar-link">redis分布式锁</a></li><li><a href="/keith-book/数据存储/redis/redis集群.html" class="sidebar-link">redis集群</a></li><li><a href="/keith-book/数据存储/redis/redis主从复制.html" class="sidebar-link">redis主从复制</a></li><li><a href="/keith-book/数据存储/redis/redis持久化.html" class="sidebar-link">redis持久化</a></li><li><a href="/keith-book/数据存储/redis/redis漏斗算法.html" class="sidebar-link">redis漏斗算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/keith-book/数据存储/mq/" class="sidebar-heading clickable"><span>mq</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/数据存储/mq/RabbitMQ基础.html" class="sidebar-link">RabbitMQ基础</a></li><li><a href="/keith-book/数据存储/mq/RabbitMQ高级.html" class="sidebar-link">RabbitMQ高级</a></li><li><a href="/keith-book/数据存储/mq/RabbitMQ应用.html" class="sidebar-link">RabbitMQ应用</a></li></ul></section></li><li><a href="/keith-book/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/elasticsearch/" class="sidebar-link">elasticsearch</a></li><li><a href="/keith-book/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/mongodb/" class="sidebar-link">mongodb</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-事务"><a href="#mysql-事务" class="header-anchor">#</a> mysql 事务</h1> <h2 id="acid"><a href="#acid" class="header-anchor">#</a> ACID</h2> <p>原子性（atomicity）：一个事务要么全部提交成功，要么全部失败回滚</p> <p>一致性（consistency）：一个事务在执行之前和执行之后，数据库都必须处于一致性状态</p> <p>隔离性（isolation）：一个事务的执行不能不被其他事务干扰</p> <p>持久性（durability）：一旦事务提交，那么它对数据库中的对应数据的状态的变更就会永久保存到数据库中</p> <h2 id="事务操作"><a href="#事务操作" class="header-anchor">#</a> 事务操作</h2> <h3 id="开启-关闭自动提交"><a href="#开启-关闭自动提交" class="header-anchor">#</a> 开启/关闭自动提交</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 查看自动提交</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%autocommit%'</span>
<span class="token comment">-- 关闭自动提交，只针对当前的会话有效</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span>
</code></pre></div><h3 id="使用事务"><a href="#使用事务" class="header-anchor">#</a> 使用事务</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 开启事务</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token comment">-- 插入数据</span>
<span class="token keyword">INSERT</span> tb_user <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> tb_user <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 提交事务</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token comment">-- 回滚事务</span>
<span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="保存点"><a href="#保存点" class="header-anchor">#</a> 保存点</h3> <p>保存点就是可以回滚到指定的之前设置的保存点。当开启事务之后操作了很多<code>SQL</code>，可以设置个保存点。当再执行的<code>SQL</code>有问题不需要的时候就可以回滚到之前设置的保存点，不用把当前事务整个回滚掉。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 设置保存点</span>
<span class="token keyword">SAVEPOINT</span> 保存点名称<span class="token punctuation">;</span>
<span class="token comment">-- 回滚到指定保存点</span>
<span class="token keyword">ROLLBACK</span> <span class="token keyword">to</span> 保存点名称<span class="token punctuation">;</span>
<span class="token comment">-- 删除保存点</span>
<span class="token keyword">RELEASE</span> <span class="token keyword">SAVEPOINT</span> 保存点名称<span class="token punctuation">;</span>
</code></pre></div><h3 id="查看隔离级别"><a href="#查看隔离级别" class="header-anchor">#</a> 查看隔离级别</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 修改隔离级别</span>
<span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> 事务隔离级别<span class="token punctuation">;</span>
<span class="token comment">-- 查看隔离级别</span>
<span class="token keyword">select</span> @<span class="token variable">@transaction_isolation</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="事务并发性问题"><a href="#事务并发性问题" class="header-anchor">#</a> 事务并发性问题</h2> <p>对于同时运行多个事务，这些事务访问<strong>数据库中相同的数据</strong>时，没有没有采取必要的隔离机制，就会导致各种并发问题：</p> <ul><li>脏读：事务A读到了事务B已修改但尚未提交的数据，此时事务B回滚，A读取数据无效，不符合一致性。</li> <li>不可重复读：事务A读到了事务B已提交的修改数据，不符合隔离性。</li> <li>幻读：事务A读到了事务B提交的新增数据，不符合隔离性。</li></ul> <h2 id="mysql提供的4种隔离级别"><a href="#mysql提供的4种隔离级别" class="header-anchor">#</a> Mysql提供的4种隔离级别</h2> <table><thead><tr><th>隔离级别</th> <th>描述</th></tr></thead> <tbody><tr><td>读未提交 READ UNCOMMITTED</td> <td>存在脏读，不可重复读，幻读问题</td></tr> <tr><td>读已提交 READ COMMITTED</td> <td>可避免脏读，存在不可重复度，幻读问题</td></tr> <tr><td>可重复读 REPEATABLE READ（默认）</td> <td>可避免脏读，不可重复读，存在幻读问题</td></tr> <tr><td>可序列化 SERIALIZABLE</td> <td>所有问题可避免，但性能低下</td></tr></tbody></table> <h2 id="mvcc-多版本并发控制"><a href="#mvcc-多版本并发控制" class="header-anchor">#</a> MVCC 多版本并发控制</h2> <p>MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读。</p> <ul><li><p>当前读
像select lock in share mode(共享锁), select for update ; update, insert ,delete(排他锁)这些操作都是一种当前读，为什么叫当前读？就是它读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</p></li> <li><p>快照读
像不加锁的select操作就是快照读，即不加锁的非阻塞读；快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读；之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于多版本并发控制，即MVCC,可以认为MVCC是行锁的一个变种，但它在很多情况下，避免了加锁操作，降低了开销；既然是基于多版本，即快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本</p></li></ul> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <h4 id="undo-log"><a href="#undo-log" class="header-anchor">#</a> Undo Log</h4> <p>每行记录除了我们自定义的字段外，还有数据库隐式定义的DB_TRX_ID,DB_ROLL_PTR,DB_ROW_ID等字段</p> <ul><li>DB_ROW_ID：隐含的自增ID（隐藏主键），如果数据表没有主键，InnoDB会自动以DB_ROW_ID产生一个聚簇索引</li> <li>DB_TRX_ID：最近 修改/插入 事务ID，记录创建这条记录/最后一次修改该记录的事务ID</li> <li>DB_ROLL_PTR：回滚指针，指向这条记录的上一个版本（存储于rollback segment里）</li></ul> <p>每次事务提交都会有将其加入 undo log 中，undo log会成为一条记录版本线性表</p> <ul><li>在事务2修改该行数据时，数据库也先为该行加锁</li> <li>然后把该行数据拷贝到undo log中，作为旧记录，发现该行记录已经有undo log了，那么最新的旧数据作为链表的表头，插在该行记录的undo log最前面</li> <li>修改该行age为30岁，并且修改隐藏字段的事务ID为当前事务2的ID, 那就是2，回滚指针指向刚刚拷贝到undo log的副本记录</li> <li>事务提交，释放锁</li></ul> <p><img src="https://img-blog.csdnimg.cn/20210125144344982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h4 id="read-view"><a href="#read-view" class="header-anchor">#</a> Read View</h4> <p>Read View 就是事务进行快照读操作的时候生产的读视图，在该事务执行的快照读的那一刻，会生成数据库系统当前的一个快照，记录并维护系统当前活跃事务的ID (当每个事务开启时，都会被分配一个ID, 这个ID是递增的，所以最新的事务，ID值越大)</p> <p>Read View 遵循一个可见性算法，主要是将要被修改的数据的最新记录中的DB_TRX_ID（当前事务ID）取出来，与系统当前其他活跃事务的ID去对比，如果 DB_TRX_ID 跟 Read View 的属性做了某些比较，不符合可见性，那就通过 DB_ROLL_PTR 回滚指针去取出 Undo Log 中的 DB_TRX_ID 再比较，即遍历链表的DB_TRX_ID（从链首到链尾，即从最近的一次修改查起），直到找到满足特定条件的DB_TRX_ID, 那么这个DB_TRX_ID所在的旧记录就是当前事务能看见的最新老版本</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/23/2021, 10:44:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/keith-book/数据存储/mysql/mysql基础.html" class="prev">
        mysql 基础
      </a></span> <span class="next"><a href="/keith-book/数据存储/mysql/mysql索引.html">
        mysql 索引
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/keith-book/assets/js/app.7ae60ab7.js" defer></script><script src="/keith-book/assets/js/2.044773f5.js" defer></script><script src="/keith-book/assets/js/50.97367378.js" defer></script>
  </body>
</html>
