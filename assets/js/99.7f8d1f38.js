(window.webpackJsonp=window.webpackJsonp||[]).push([[99],{449:function(t,_,a){"use strict";a.r(_);var s=a(42),r=Object(s.a)({},(function(){var t=this,_=t.$createElement,a=t._self._c||_;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"分布式事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[t._v("#")]),t._v(" 分布式事务")]),t._v(" "),a("h2",{attrs:{id:"_2pc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2pc"}},[t._v("#")]),t._v(" 2PC")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("事务管理器询问每一个服务是否可以提交，任何一个服务拒绝，事务管理器全部回滚。")])]),t._v(" "),a("li",[a("p",[t._v("每个服务都响应可以后执行。")])])]),t._v(" "),a("p",[a("strong",[t._v("实现方式")]),t._v("：Spring + JTA（XA 协议的 Java 实现）")]),t._v(" "),a("p",[t._v("协调者有超时机制，如果在一定的时间内未收到客户端的消息默认失败")]),t._v(" "),a("p",[t._v("缺点：同步阻塞，单点故障")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210106220851600.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),t._v(" "),a("h2",{attrs:{id:"_3pc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3pc"}},[t._v("#")]),t._v(" 3PC")]),t._v(" "),a("blockquote",[a("p",[t._v("在两阶段上增加了：客户端超时机制和预提交机制")])]),t._v(" "),a("ol",[a("li",[t._v("CanCommit：询问")]),t._v(" "),a("li",[t._v("preCommit：预提交")]),t._v(" "),a("li",[t._v("doCommit：提交")])]),t._v(" "),a("p",[t._v("假如有任何一个 Conhort 向 Coordinator 发送了 No 响应，或者等待超时之后，Coordinator 都没有接收到 Cohort 的响应，那么就中断事务")]),t._v(" "),a("p",[t._v("发送中断请求：Coordinator 向所有 Cohort 发送 abort 请求")]),t._v(" "),a("p",[t._v("中断事务：Corhort 收到来自 Coordinator 的 abort 请求（或超时还未收到请求），执行事务中断")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210124101902970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),t._v(" "),a("h2",{attrs:{id:"tcc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcc"}},[t._v("#")]),t._v(" TCC")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Try：预先占有资源")])]),t._v(" "),a("li",[a("p",[t._v("Confirm：确认提交实际操作资源")])]),t._v(" "),a("li",[a("p",[t._v("Cancel：取消占有，即把那些执行成功的回滚。")])])]),t._v(" "),a("p",[a("strong",[t._v("使用场景")]),t._v("：对分布式事务一致性要求高，如跟钱相关的。")]),t._v(" "),a("p",[a("strong",[t._v("缺点")]),t._v("：重耦合，需要手写补偿逻辑。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210106221025144.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),t._v(" "),a("h2",{attrs:{id:"seata"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata"}},[t._v("#")]),t._v(" Seata")]),t._v(" "),a("p",[t._v("http://seata.io/zh-cn/docs/overview/what-is-seata.html")]),t._v(" "),a("blockquote",[a("p",[t._v("TC：Transaction Coordinator")]),t._v(" "),a("p",[t._v("TM：Transaction Manager")]),t._v(" "),a("p",[t._v("RM：Resorce Manager")]),t._v(" "),a("p",[t._v("TM is a kind of RM.")]),t._v(" "),a("p",[t._v("本地锁：锁一个分布式事务中的一个服务")]),t._v(" "),a("p",[t._v("全局锁：锁一个分布式事务中的所有服务")]),t._v(" "),a("p",[t._v("Seata 支持的事务模式：AT, TCC, SAGA, XA")])]),t._v(" "),a("p",[a("strong",[t._v("流程")])]),t._v(" "),a("p",[a("strong",[t._v("分布式事务1")])]),t._v(" "),a("p",[t._v("获取本地锁 > 执行 SQL > "),a("font",{attrs:{color:"red"}},[t._v("获取全局锁 ")]),t._v("> 提交本地事务 > 释放本地锁 > 全局提交 > 释放全局锁")],1),t._v(" "),a("p",[a("strong",[t._v("分布式事务2")])]),t._v(" "),a("p",[t._v("获取本地锁 > 执行 SQL > "),a("font",{attrs:{color:"red"}},[t._v("重复获取全局锁（有超时时间） ")]),t._v("> 提交本地事务 > 释放本地锁 > 全局提交 > 释放全局锁")],1),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210124195830118.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),t._v(" "),a("h2",{attrs:{id:"本地消息表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本地消息表"}},[t._v("#")]),t._v(" 本地消息表")]),t._v(" "),a("blockquote",[a("p",[t._v("本地事务 + 定时任务 + 消息队列 + 事件表")])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("A系统先插入数据到业务表，再插入消息表，再插入到MQ。")])]),t._v(" "),a("li",[a("p",[t._v("B系统接收到消息，先插入数据到消息表，再插入业务表，如果消息已被处理就回滚，防止重复消费。")])]),t._v(" "),a("li",[a("p",[t._v("B系统执行成功后，更新本地消息表以及 A 系统消息表的状态。")])]),t._v(" "),a("li",[a("p",[t._v("B系统执行失败，就不会更新，A系统会定时扫描本地消息表，如果有未处理消息，会再次发送到MQ。")])])]),t._v(" "),a("p",[a("strong",[t._v("缺陷")]),t._v("：能保证事务的一致性，但是时效性太差")]),t._v(" "),a("p",[t._v("事件表字段")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("event_type: 事件类型\nevent_process: 事件环节 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("new published processed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nevent_content: 事件内容，保存事件发生时需要传递的数据\n")])])]),a("p",[t._v("流程图")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210124102926916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),t._v(" "),a("h2",{attrs:{id:"可靠消息服务-最大努力通知"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可靠消息服务-最大努力通知"}},[t._v("#")]),t._v(" 可靠消息服务 - 最大努力通知")]),t._v(" "),a("ol",[a("li",[t._v("A系统本地事务执行完之后，发送个消息到 MQ。")]),t._v(" "),a("li",[t._v("最大努力通知服务会消费 MQ 然后写入数据库中记录下来，再调用B系统的接口。")]),t._v(" "),a("li",[t._v("若系统 B 执行失败，最大努力通知服务会定时尝试重新调用B系统，反复N次，最后还是不行就放弃。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210124172031233.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})])])}),[],!1,null,null,null);_.default=r.exports}}]);