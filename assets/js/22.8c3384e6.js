(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{383:function(t,a,s){"use strict";s.r(a);var n=s(42),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"spring-cloud-链路追踪"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-链路追踪"}},[t._v("#")]),t._v(" Spring Cloud 链路追踪")]),t._v(" "),s("p",[t._v("如果能跟踪每个请求，中间请求经过哪些微服务，请求耗时，网络延迟，业务逻辑耗时等。我们就能更好地分析系统瓶颈、解决系统问题。")]),t._v(" "),s("p",[t._v("链路追踪目的：解决错综复杂的服务调用中链路的查看。排查慢服务。")]),t._v(" "),s("p",[t._v("市面上链路追踪产品大部分都是基于google的Dapper论文")]),t._v(" "),s("p",[t._v("zipkin,twitter：开源的，是严格按照谷歌的Dapper论文来的")]),t._v(" "),s("p",[t._v("pinpoint：韩国的 Naver 公司的")]),t._v(" "),s("p",[t._v("Cat：美团点评")]),t._v(" "),s("p",[t._v("EagleEye：淘宝")]),t._v(" "),s("h2",{attrs:{id:"链路追踪要考虑的几个问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#链路追踪要考虑的几个问题"}},[t._v("#")]),t._v(" 链路追踪要考虑的几个问题")]),t._v(" "),s("ol",[s("li",[t._v("探针的性能消耗，尽量不影响服务本身。")]),t._v(" "),s("li",[t._v("易用，开发可以很快接入，别浪费太多精力。")]),t._v(" "),s("li",[t._v("数据分析，要实时分析，维度足够。")])]),t._v(" "),s("h2",{attrs:{id:"spring-cloud-sleuth"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-sleuth"}},[t._v("#")]),t._v(" Spring Cloud Sleuth")]),t._v(" "),s("blockquote",[s("p",[t._v("Sleuth 是 Spring Cloud 的分布式跟踪解决方案")])]),t._v(" "),s("h3",{attrs:{id:"基本概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本概念"}},[t._v("#")]),t._v(" 基本概念")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("span：基本工作单元，一次链路调用，创建一个span")]),t._v(" "),s("p",[t._v("span 用一个64位 ID 唯一标识。包括：ID，描述，时间戳事件，spanId，span父id")]),t._v(" "),s("p",[t._v("span 被启动和停止时，记录了时间信息，初始化span叫：root span，它的 span id 和 trace id 相等")])]),t._v(" "),s("li",[s("p",[t._v("trace：一组共享 "),s("code",[t._v("root span")]),t._v(" 的 span 组成的树状结构称为 trace")]),t._v(" "),s("p",[t._v("trace 也有一个64位 ID，trace 中所有 span 共享一个 trace id，类似于一颗 span 树。")])]),t._v(" "),s("li",[s("p",[t._v("annotation：用来记录事件的存在，核心annotation用来定义请求的开始和结束。")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("CS：Client Send，客户端发起请求，客户端发起请求描述了span开始。")])]),t._v(" "),s("li",[s("p",[t._v("SR：Server Received，服务端接到请求，服务端获得请求并准备处理它，SR-CS=网络延迟。")])]),t._v(" "),s("li",[s("p",[t._v("SS：Server Send，服务器端处理完成，并将结果发送给客户端，表示服务器完成请求处理，响应客户端时，SS-SR=服务器处理请求的时间。")])]),t._v(" "),s("li",[s("p",[t._v("CR：Client Received，客户端接受服务端信息，span结束的标识，客户端接收到服务器的响应，CR-CS=客户端发出请求到服务器响应的总时间。")])])])])]),t._v(" "),s("p",[t._v("其实数据结构是一颗树，从root span 开始。")]),t._v(" "),s("h3",{attrs:{id:"sleuth-使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sleuth-使用"}},[t._v("#")]),t._v(" Sleuth 使用")]),t._v(" "),s("p",[t._v("pom")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 引入sleuth依赖 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.cloud"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter-sleuth"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("请求日志")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("--- 发起调用方 ---\n[api-driver,1a409c98e7a3cdbf,1a409c98e7a3cdbf,true] \n\n--- 接收调用方 ---\n[service-sms,1a409c98e7a3cdbf,b3d93470b5cf8434,true]\n\n--- 参数解释 ---\n[服务名称，traceId（一条请求调用链中 唯一ID），spanID（基本的工作单元，获取数据等），是否让zipkin收集和展示此信息]\n")])])]),s("h2",{attrs:{id:"spring-cloud-zipkin"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-zipkin"}},[t._v("#")]),t._v(" Spring Cloud Zipkin")]),t._v(" "),s("h3",{attrs:{id:"基本概念-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本概念-2"}},[t._v("#")]),t._v(" 基本概念")]),t._v(" "),s("p",[t._v("zipkin是twitter开源的分布式跟踪系统。")]),t._v(" "),s("p",[t._v("原理收集系统的时序数据，从而追踪微服务架构中系统延时等问题，还有一个友好的界面。")]),t._v(" "),s("p",[t._v("ZipKin的组成：Collector、Storage、Restful Api、Web UI")]),t._v(" "),s("p",[t._v("Sleuth 收集跟踪信息通过 http 请求发送给 Zipkin Server，Zipkin 将跟踪信息存储，以及提供RESTful API接口，Zipkin UI 通过调用 Api进行数据展示。默认内存存储，可以用mysql，ES等存储。")]),t._v(" "),s("h3",{attrs:{id:"zipkin-使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#zipkin-使用"}},[t._v("#")]),t._v(" ZipKin 使用")]),t._v(" "),s("p",[t._v("pom")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- zipkin --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.cloud"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter-zipkin"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("配置")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("zipkin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("base-url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("9411/\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sleuth")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sampler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#采样比例1")]),t._v("\n")])])]),s("p",[t._v("下载启动 ZipKin")]),t._v(" "),s("p",[t._v("https://zipkin.io/pages/quickstart.html")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -sSL https://zipkin.io/quickstart.sh "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v(" -s\njava -jar zipkin.jar\n")])])]),s("p",[t._v("访问地址：http://localhost:9411/")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210208165821768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);