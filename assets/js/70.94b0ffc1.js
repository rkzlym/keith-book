(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{420:function(s,a,t){"use strict";t.r(a);var e=t(42),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis集群"}},[s._v("#")]),s._v(" redis集群")]),s._v(" "),t("h2",{attrs:{id:"redis单机问题与解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis单机问题与解决"}},[s._v("#")]),s._v(" redis单机问题与解决")]),s._v(" "),t("ol",[t("li",[s._v("单点故障：增加从机，只可以读不可以写")]),s._v(" "),t("li",[s._v("容量有限：通过业务将redis拆分成多个")]),s._v(" "),t("li",[s._v("压力较大：在同一种业务下再进行细分，如将1kw的用户存入一个redis")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210213111000825.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"集群之间的通信"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集群之间的通信"}},[s._v("#")]),s._v(" 集群之间的通信")]),s._v(" "),t("p",[s._v("各个数据库相互通信，保存各个库中槽的编号数据")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("一次命中，直接返回")])]),s._v(" "),t("li",[t("p",[s._v("一次未命中，告知具体位置")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200203150519604.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"集群配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集群配置"}},[s._v("#")]),s._v(" 集群配置")]),s._v(" "),t("p",[s._v("准备三个redis服务，6379 6380 6381")]),s._v(" "),t("h3",{attrs:{id:"命令启动集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令启动集群"}},[s._v("#")]),s._v(" 命令启动集群")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主机正常启动")]),s._v("\nredis-server ./6379.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从机追随主机启动")]),s._v("\nredis-server ./6380.conf --replicaof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\nredis-server ./6381.conf --replicaof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果没有哨兵模式，主机6379挂了，人工将从机6380切换为主机，并让6381追随它")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:638"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(" replicaof no one\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:638"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" replicaof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\n")])])]),t("h3",{attrs:{id:"配置文件启动集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件启动集群"}},[s._v("#")]),s._v(" 配置文件启动集群")]),s._v(" "),t("ol",[t("li",[s._v("修改redis.conf")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启集群")]),s._v("\ncluster-enabled "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置集群配置文件，每个服务器要不一样")]),s._v("\ncluster-config-file node-6379.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置下线时间")]),s._v("\ncluster-node-timeoout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("依次启动集群服务")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-server redis-6379.conf\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("将redis服务连接起来\n需要执行src目录下的redis-trib.rb，且需要ruby环境\n下列命名表示1个master有1个slave，且一共有6个服务器")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("./redis-trib.rb create --replicas "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6379 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6380 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6381 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6382 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6383 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6384\n")])])]),t("h2",{attrs:{id:"哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式"}},[s._v("#")]),s._v(" 哨兵模式")]),s._v(" "),t("h3",{attrs:{id:"哨兵简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵简介"}},[s._v("#")]),s._v(" 哨兵简介")]),s._v(" "),t("p",[s._v("哨兵（sentinel）是一个分布式系统，用于对主从结构中的每台服务器进行监控，当出现故障时通过投票机制选择新的master并将所有slave连接到新的master。")]),s._v(" "),t("p",[t("strong",[s._v("作用")])]),s._v(" "),t("ol",[t("li",[s._v("监控：不断的检查master和slave是否正常运行，master存活检测、master与slave运行情况检测")]),s._v(" "),t("li",[s._v("通知：当被监控的服务器出现故障时，向其他客户端发送通知")]),s._v(" "),t("li",[s._v("自动故障转移：断开master和slave连接，选取一个slave作master，将其他slave连接到新master，并告知客户端新的服务器地址")])]),s._v(" "),t("p",[t("strong",[s._v("说明")])]),s._v(" "),t("ul",[t("li",[s._v("哨兵也是一台redis服务器，只是不提供数据服务")]),s._v(" "),t("li",[s._v("通常哨兵的配置数量为单数")])]),s._v(" "),t("h3",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),t("p",[s._v("26379.conf 26380.conf 26381.conf")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定端口 26379 26380 26381")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2个哨兵认为这个master挂了就挂了")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 30秒未响应判断死亡")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n")])])]),t("p",[s._v("启动哨兵服务器")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-server ./26379.conf --sentinel\n")])])]),t("p",[s._v("查看哨兵的通信，在master节点输入命令")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("PSUBSCRIBE *\n")])])]),t("p",[s._v("可以看到以下输出，哨兵在询问master是否存活")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__sentinel__:hello"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1,26379,36f7e5a15c4bda4ea9394a8b90c5c2c307123b25,0,mymaster,127.0.0.1,6379,0"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pmessage"')]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);