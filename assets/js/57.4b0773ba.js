(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{409:function(s,a,t){"use strict";t.r(a);var e=t(42),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mysql-锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql-锁"}},[s._v("#")]),s._v(" mysql 锁")]),s._v(" "),t("blockquote",[t("p",[s._v("Mysql有三种锁：表锁(偏读)、行锁(偏写)、页锁")])]),s._v(" "),t("h2",{attrs:{id:"锁概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁概述"}},[s._v("#")]),s._v(" 锁概述")]),s._v(" "),t("p",[s._v("不同的存储引擎支持 不同的锁机制")]),s._v(" "),t("p",[s._v("MyISAM 和 MEMORY 存储引擎采用的是表级锁（table-level locking）")]),s._v(" "),t("p",[s._v("InnoDB 存储引擎既支持行级锁（ row-level locking），也支持表级锁，默认情况下是采用行级锁")]),s._v(" "),t("p",[s._v("锁的的是索引")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("表级锁： 开销小，加锁快；不会出现死锁(因为 MyISAM 会一次性获得 SQL 所需的全部锁)。锁定粒度大，发生锁冲突的概率最高，并发度最低。")])]),s._v(" "),t("li",[t("p",[s._v("行级锁： 开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。")])]),s._v(" "),t("li",[t("p",[s._v("页锁：开销和加锁速度介于表锁和行锁之间；会出现死锁；锁定粒度介于表锁和行锁之间， 并发度一般。")])])]),s._v(" "),t("h2",{attrs:{id:"查看锁命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看锁命令"}},[s._v("#")]),s._v(" 查看锁命令")]),s._v(" "),t("h3",{attrs:{id:"_1-查看锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-查看锁"}},[s._v("#")]),s._v(" 1. 查看锁")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("open")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("In_use为0表示没有被锁\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200201080542825.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_2-分析表锁定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-分析表锁定"}},[s._v("#")]),s._v(" 2. 分析表锁定")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%table%'")]),s._v("\n")])])]),t("ul",[t("li",[s._v("Table_locks_immediate：产生表级锁定的次数（锁的查询次数）。")]),s._v(" "),t("li",[s._v("Table_locks_waited：出现表级锁定争用而发生等待的次数，此值高说明存在严重表级锁争用情况。")])]),s._v(" "),t("h2",{attrs:{id:"表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#表锁"}},[s._v("#")]),s._v(" 表锁")]),s._v(" "),t("h3",{attrs:{id:"_1-读锁-共享锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-读锁-共享锁"}},[s._v("#")]),s._v(" 1. 读锁（共享锁）")]),s._v(" "),t("p",[s._v("Session 1 为Table增加"),t("font",{attrs:{color:"red"}},[s._v("读锁")]),s._v("之后：")],1),s._v(" "),t("ul",[t("li",[s._v("Session 1 只能读锁定表，不能读其他表，写锁定表"),t("font",{attrs:{color:"red"}},[s._v("报错")]),s._v("。")],1),s._v(" "),t("li",[s._v("Session 2 可以读任何表，写锁定表"),t("font",{attrs:{color:"red"}},[s._v("阻塞")]),s._v("。")],1)]),s._v(" "),t("h3",{attrs:{id:"_2-写锁-独占锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-写锁-独占锁"}},[s._v("#")]),s._v(" 2. 写锁（独占锁）")]),s._v(" "),t("p",[s._v("Session 1 为Table增加"),t("font",{attrs:{color:"red"}},[s._v("写锁")]),s._v("之后：")],1),s._v(" "),t("ul",[t("li",[s._v("Session 1 可以做锁定表进行任何操作")]),s._v(" "),t("li",[s._v("Session 2 无法对锁定表进行任何操作")])]),s._v(" "),t("h3",{attrs:{id:"_3-相关命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-相关命令"}},[s._v("#")]),s._v(" 3. 相关命令")]),s._v(" "),t("p",[t("strong",[s._v("加读锁")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" 表名"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 表名"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("加写锁")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" 表名"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 表名"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("解锁")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unlock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h2",{attrs:{id:"行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁"}},[s._v("#")]),s._v(" 行锁")]),s._v(" "),t("h3",{attrs:{id:"_1-开启事务即开启了行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-开启事务即开启了行锁"}},[s._v("#")]),s._v(" 1. 开启事务即开启了行锁")]),s._v(" "),t("p",[s._v("提交事务之前，其它会话查询到的都是未提交的数据，如果更新了同一行，会被阻塞，直到这个事务被提交。")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" autocommit "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" dept "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" dname "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'开发部2'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" deptno "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"_2-悲观锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-悲观锁"}},[s._v("#")]),s._v(" 2. 悲观锁")]),s._v(" "),t("p",[s._v("当查询deptno=1的数据的时候，加"),t("code",[s._v("for update")]),s._v("语句，此时其它会话修改这条记录就会被阻塞。")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" dept "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" deptno "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"_3-乐观锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-乐观锁"}},[s._v("#")]),s._v(" 3. 乐观锁")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" t_goods   \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("version"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("version"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{id} and version=#{version};  ")]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);