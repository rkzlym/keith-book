<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 锁 | 鸿鹄笔记</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" content="/favicon.ico">
    <meta name="description" content="鸿鹄的个人笔记">
    <meta rel="author" content="Keith">
    
    <link rel="preload" href="/keith-book/assets/css/0.styles.86c07c9d.css" as="style"><link rel="preload" href="/keith-book/assets/js/app.7ae60ab7.js" as="script"><link rel="preload" href="/keith-book/assets/js/2.044773f5.js" as="script"><link rel="preload" href="/keith-book/assets/js/11.a6a3b5c9.js" as="script"><link rel="prefetch" href="/keith-book/assets/js/10.13f771ae.js"><link rel="prefetch" href="/keith-book/assets/js/100.af11b532.js"><link rel="prefetch" href="/keith-book/assets/js/101.b5e393e3.js"><link rel="prefetch" href="/keith-book/assets/js/102.7a7d2386.js"><link rel="prefetch" href="/keith-book/assets/js/103.4b5c8925.js"><link rel="prefetch" href="/keith-book/assets/js/104.8c63d13c.js"><link rel="prefetch" href="/keith-book/assets/js/105.2bfbf884.js"><link rel="prefetch" href="/keith-book/assets/js/106.47faa20d.js"><link rel="prefetch" href="/keith-book/assets/js/107.9ad2a314.js"><link rel="prefetch" href="/keith-book/assets/js/108.008b5fa7.js"><link rel="prefetch" href="/keith-book/assets/js/109.62761423.js"><link rel="prefetch" href="/keith-book/assets/js/110.8afb8e61.js"><link rel="prefetch" href="/keith-book/assets/js/111.57012fed.js"><link rel="prefetch" href="/keith-book/assets/js/112.535b424f.js"><link rel="prefetch" href="/keith-book/assets/js/113.c23530b0.js"><link rel="prefetch" href="/keith-book/assets/js/114.834b12cd.js"><link rel="prefetch" href="/keith-book/assets/js/115.ce1b3169.js"><link rel="prefetch" href="/keith-book/assets/js/116.65b1520c.js"><link rel="prefetch" href="/keith-book/assets/js/117.fd80cfe9.js"><link rel="prefetch" href="/keith-book/assets/js/118.f05a98aa.js"><link rel="prefetch" href="/keith-book/assets/js/119.4cea8196.js"><link rel="prefetch" href="/keith-book/assets/js/12.42246af7.js"><link rel="prefetch" href="/keith-book/assets/js/120.275abc51.js"><link rel="prefetch" href="/keith-book/assets/js/121.0a4ec53d.js"><link rel="prefetch" href="/keith-book/assets/js/122.aebc3a0f.js"><link rel="prefetch" href="/keith-book/assets/js/123.a9c61bf2.js"><link rel="prefetch" href="/keith-book/assets/js/124.54f656c9.js"><link rel="prefetch" href="/keith-book/assets/js/125.554faf7e.js"><link rel="prefetch" href="/keith-book/assets/js/126.88f70416.js"><link rel="prefetch" href="/keith-book/assets/js/127.7aeb22c3.js"><link rel="prefetch" href="/keith-book/assets/js/128.5e8f8a6c.js"><link rel="prefetch" href="/keith-book/assets/js/129.d96c386d.js"><link rel="prefetch" href="/keith-book/assets/js/13.614d862e.js"><link rel="prefetch" href="/keith-book/assets/js/14.d938dc50.js"><link rel="prefetch" href="/keith-book/assets/js/15.27956206.js"><link rel="prefetch" href="/keith-book/assets/js/16.8259d213.js"><link rel="prefetch" href="/keith-book/assets/js/17.59fccf41.js"><link rel="prefetch" href="/keith-book/assets/js/18.1ae9a1fd.js"><link rel="prefetch" href="/keith-book/assets/js/19.3f56180c.js"><link rel="prefetch" href="/keith-book/assets/js/20.a6a8e2d9.js"><link rel="prefetch" href="/keith-book/assets/js/21.fa3c5532.js"><link rel="prefetch" href="/keith-book/assets/js/22.8c3384e6.js"><link rel="prefetch" href="/keith-book/assets/js/23.8ea8dbc6.js"><link rel="prefetch" href="/keith-book/assets/js/24.d65bce25.js"><link rel="prefetch" href="/keith-book/assets/js/25.b2d0686f.js"><link rel="prefetch" href="/keith-book/assets/js/26.fdc5f5b5.js"><link rel="prefetch" href="/keith-book/assets/js/27.8bb47b1d.js"><link rel="prefetch" href="/keith-book/assets/js/28.e087e2b0.js"><link rel="prefetch" href="/keith-book/assets/js/29.4306565c.js"><link rel="prefetch" href="/keith-book/assets/js/3.83866d44.js"><link rel="prefetch" href="/keith-book/assets/js/30.92b9c15a.js"><link rel="prefetch" href="/keith-book/assets/js/31.a231c5d0.js"><link rel="prefetch" href="/keith-book/assets/js/32.30b3c540.js"><link rel="prefetch" href="/keith-book/assets/js/33.d4ae83e5.js"><link rel="prefetch" href="/keith-book/assets/js/34.2d831459.js"><link rel="prefetch" href="/keith-book/assets/js/35.fd638673.js"><link rel="prefetch" href="/keith-book/assets/js/36.a936bf23.js"><link rel="prefetch" href="/keith-book/assets/js/37.f0a03b08.js"><link rel="prefetch" href="/keith-book/assets/js/38.635b6ac3.js"><link rel="prefetch" href="/keith-book/assets/js/39.dc3d7a09.js"><link rel="prefetch" href="/keith-book/assets/js/4.e2dc8d0c.js"><link rel="prefetch" href="/keith-book/assets/js/40.06264354.js"><link rel="prefetch" href="/keith-book/assets/js/41.a5492cc2.js"><link rel="prefetch" href="/keith-book/assets/js/42.be57bef1.js"><link rel="prefetch" href="/keith-book/assets/js/43.88a27c79.js"><link rel="prefetch" href="/keith-book/assets/js/44.c4499e0a.js"><link rel="prefetch" href="/keith-book/assets/js/45.bc3d4bb0.js"><link rel="prefetch" href="/keith-book/assets/js/46.77fe74ff.js"><link rel="prefetch" href="/keith-book/assets/js/47.a6d9e6fb.js"><link rel="prefetch" href="/keith-book/assets/js/48.aef4698e.js"><link rel="prefetch" href="/keith-book/assets/js/49.a0d6928f.js"><link rel="prefetch" href="/keith-book/assets/js/5.281837e2.js"><link rel="prefetch" href="/keith-book/assets/js/50.97367378.js"><link rel="prefetch" href="/keith-book/assets/js/51.5aa97e63.js"><link rel="prefetch" href="/keith-book/assets/js/52.c8645f8c.js"><link rel="prefetch" href="/keith-book/assets/js/53.ddb048d3.js"><link rel="prefetch" href="/keith-book/assets/js/54.4b3240ad.js"><link rel="prefetch" href="/keith-book/assets/js/55.906f19b3.js"><link rel="prefetch" href="/keith-book/assets/js/56.ab84e214.js"><link rel="prefetch" href="/keith-book/assets/js/57.4b0773ba.js"><link rel="prefetch" href="/keith-book/assets/js/58.ba67fb3c.js"><link rel="prefetch" href="/keith-book/assets/js/59.c70cec7d.js"><link rel="prefetch" href="/keith-book/assets/js/6.a3b769ae.js"><link rel="prefetch" href="/keith-book/assets/js/60.328ff957.js"><link rel="prefetch" href="/keith-book/assets/js/61.821c95c9.js"><link rel="prefetch" href="/keith-book/assets/js/62.a8706fa5.js"><link rel="prefetch" href="/keith-book/assets/js/63.7893739a.js"><link rel="prefetch" href="/keith-book/assets/js/64.e0e82da5.js"><link rel="prefetch" href="/keith-book/assets/js/65.c8630545.js"><link rel="prefetch" href="/keith-book/assets/js/66.71acb88b.js"><link rel="prefetch" href="/keith-book/assets/js/67.1d69d8ae.js"><link rel="prefetch" href="/keith-book/assets/js/68.cbcd16b5.js"><link rel="prefetch" href="/keith-book/assets/js/69.7ad720f1.js"><link rel="prefetch" href="/keith-book/assets/js/7.4d8a2bf7.js"><link rel="prefetch" href="/keith-book/assets/js/70.94b0ffc1.js"><link rel="prefetch" href="/keith-book/assets/js/71.f82c5f63.js"><link rel="prefetch" href="/keith-book/assets/js/72.bc8c9c4e.js"><link rel="prefetch" href="/keith-book/assets/js/73.0705a1c5.js"><link rel="prefetch" href="/keith-book/assets/js/74.5f096bb0.js"><link rel="prefetch" href="/keith-book/assets/js/75.3f8747a5.js"><link rel="prefetch" href="/keith-book/assets/js/76.651eb39a.js"><link rel="prefetch" href="/keith-book/assets/js/77.f999879e.js"><link rel="prefetch" href="/keith-book/assets/js/78.61f7757f.js"><link rel="prefetch" href="/keith-book/assets/js/79.8bd2dd06.js"><link rel="prefetch" href="/keith-book/assets/js/8.d352d476.js"><link rel="prefetch" href="/keith-book/assets/js/80.b123974d.js"><link rel="prefetch" href="/keith-book/assets/js/81.2009dcf1.js"><link rel="prefetch" href="/keith-book/assets/js/82.29cd7333.js"><link rel="prefetch" href="/keith-book/assets/js/83.936db179.js"><link rel="prefetch" href="/keith-book/assets/js/84.bc885c59.js"><link rel="prefetch" href="/keith-book/assets/js/85.d4e8c66d.js"><link rel="prefetch" href="/keith-book/assets/js/86.7cc46a2b.js"><link rel="prefetch" href="/keith-book/assets/js/87.2c8ce44d.js"><link rel="prefetch" href="/keith-book/assets/js/88.bb2c361f.js"><link rel="prefetch" href="/keith-book/assets/js/89.9a1ee5e4.js"><link rel="prefetch" href="/keith-book/assets/js/9.29357314.js"><link rel="prefetch" href="/keith-book/assets/js/90.aa69ffbe.js"><link rel="prefetch" href="/keith-book/assets/js/91.a8944021.js"><link rel="prefetch" href="/keith-book/assets/js/92.cd8a456d.js"><link rel="prefetch" href="/keith-book/assets/js/93.0b16e3c6.js"><link rel="prefetch" href="/keith-book/assets/js/94.d8822045.js"><link rel="prefetch" href="/keith-book/assets/js/95.fa963ca4.js"><link rel="prefetch" href="/keith-book/assets/js/96.c4728133.js"><link rel="prefetch" href="/keith-book/assets/js/97.f29d3516.js"><link rel="prefetch" href="/keith-book/assets/js/98.64cb768c.js"><link rel="prefetch" href="/keith-book/assets/js/99.7f8d1f38.js">
    <link rel="stylesheet" href="/keith-book/assets/css/0.styles.86c07c9d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/keith-book/" class="home-link router-link-active"><img src="/keith-book/favicon.ico" alt="鸿鹄笔记" class="logo"> <span class="site-name can-hide">鸿鹄笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/keith-book/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/keith-book/Java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/keith-book/Spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/keith-book/数据存储/" class="nav-link">
  数据存储
</a></div><div class="nav-item"><a href="/keith-book/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/keith-book/数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/keith-book/服务器/" class="nav-link">
  服务器
</a></div><div class="nav-item"><a href="/keith-book/前端/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/keith-book/拓展/" class="nav-link">
  拓展
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/keith-book/Java/" class="sidebar-heading clickable router-link-active open"><span>Java</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keith-book/Java/Java基础.html" class="sidebar-link">Java 基础</a></li><li><a href="/keith-book/Java/Java集合.html" class="sidebar-link">Java 集合</a></li><li><a href="/keith-book/Java/JavaIO.html" class="sidebar-link">Java IO</a></li><li><a href="/keith-book/Java/JavaJVM.html" class="sidebar-link">Java JVM</a></li><li><a href="/keith-book/Java/Java多线程.html" class="sidebar-link">Java 多线程</a></li><li><a href="/keith-book/Java/Java锁.html" class="active sidebar-link">Java 锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#jmm-java-memory-model" class="sidebar-link">JMM (Java Memory Model)</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#volatile" class="sidebar-link">volatile</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#cas-compare-and-set" class="sidebar-link">CAS (Compare And Set)</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#锁的分类" class="sidebar-link">锁的分类</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#锁概念" class="sidebar-link">锁概念</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#juc和同步锁锁" class="sidebar-link">JUC和同步锁锁</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#线程等待和唤醒" class="sidebar-link">线程等待和唤醒</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#aqs-abstractqueuedsynchronizer" class="sidebar-link">AQS (AbstractQueuedSynchronizer)</a></li><li class="sidebar-sub-header"><a href="/keith-book/Java/Java锁.html#threadlocal" class="sidebar-link">ThreadLocal</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java-锁"><a href="#java-锁" class="header-anchor">#</a> Java 锁</h1> <h2 id="jmm-java-memory-model"><a href="#jmm-java-memory-model" class="header-anchor">#</a> JMM (Java Memory Model)</h2> <p>是一组规范，<font color="red">可见性、原子性、有序性</font>，定义了程序中各个变量的访问方式。</p> <p><strong>解释</strong>：线程创建时JVM会为其创建工作内存（线程私有），JMM规定所有变量存储在主内存（共享），但线程必须在工作内存中操作变量。具体流程：<font color="red">拷贝-&gt;操作-&gt;写回</font>。各个工作内存存储主内存变量的复印件，不同线程无法互相访问，线程间通信必须通过主内存。</p> <p><img src="https://img-blog.csdnimg.cn/20210121135743932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p><strong>JMM关于同步的规定</strong>：</p> <ol><li>线程解锁前，必须把共享变量的值刷新回主内存。</li> <li>线程加锁前，必须读取主内存的最新值到工作内存。</li> <li>加锁解锁是同一把锁。</li></ol> <h2 id="volatile"><a href="#volatile" class="header-anchor">#</a> volatile</h2> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <p>保证可见性，禁止指令重排</p> <h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <p>缓存一致性协议。JMM模型里有8个指令完成数据的读写，通过其中load和store指令相互组成的4个内存屏障实现禁止指令重排序。</p> <p><strong>字节码层面</strong>：ACC_VOLATILE</p> <p><strong>JVM层面</strong></p> <p><img src="https://img-blog.csdnimg.cn/20210117102410887.png" alt="在这里插入图片描述"></p> <p><strong>JVM内存屏障</strong></p> <p>LoadLoad：在Load2及后续读取操作的数据被访问前，保证Load1要读取的数据读取完毕。</p> <p>StoreStore：在Store2及后续写入操作执行前，保证Store1的写入操作对其它处理器可见。</p> <p>LoadStore：在Store2及后续写入操作刷出前，保证Load1要读取的数据被读取完毕。</p> <p>StoreLoad：在Load2及后续所有读取操作执行前，保证Store1的写入对所有处理器可见。</p> <p><strong>OS层面：硬件内存屏障、原子指令</strong></p> <p>sfence：save | 在sfence指令前的写操作必须在sfence指令后的写操作前完成</p> <p>lfence：load | 在lfence指令前的读操作必须在lfence指令后的读操作前完成</p> <p>mfence：modify/mix | 在mfence指令前的读写操作必须在mfence指令后的读写操作前完成</p> <p>原子指令：如x86上的lock前缀指令是一个Full Barrier，执行时会锁住内存子系统来确保执行顺序</p> <p><strong>为什么volatile不能实现原子性</strong></p> <p>没有原子性是因为底层代码一个++操作会被写成多行c++，这时候失去CPU分片就会值被改掉</p> <p><strong>单例模式中的DCL为什么要加volatile</strong></p> <p>由于指令重排，对象在半初始化状态的时候就赋值给这个变量了，即instance已经不再是null，第二个线程就直接拿来使用这个半初始化状态的对象。</p> <p><strong>volatile引用对象</strong></p> <p>如果volatile修饰的是一个引用对象，那么引用对象内部的属性发生改变volatile是无法观察到的。</p> <h2 id="cas-compare-and-set"><a href="#cas-compare-and-set" class="header-anchor">#</a> CAS (Compare And Set)</h2> <p><strong>作用</strong>：线程的期望值和物理内存真实值一样则修改，否则需要重新获得主物理内存的真实值，这个过程是<font color="red">原子</font>的。</p> <p><strong>原理</strong>：Unsafe、自旋锁、乐观锁</p> <ul><li><p>Unsafe：Java无法直接访问底层系统，可以基于Unsafe内部native方法可以像C的指针一样直接操作内存。</p></li> <li><p>自旋锁：循环判断工作内存与主内存的值是否相等，如相等则返回。</p></li></ul> <p><strong>缺点</strong>：循环时间长开销大、只能保证一个共享变量的原子操作、ABA问题。</p> <p><strong>CAS是怎么保证原子性的</strong></p> <p>获取内存中的值，CAS比较不一致，则继续获取内存中的值，直到CAS成功为止</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// var1: 当前对象</span>
<span class="token comment">// var2: 当前对象的内存偏移量地址</span>
<span class="token comment">// var4: 增加的值</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">int</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> var5<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据当前对象的内存偏移量获取当前对象的值</span>
        var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果CAS比较结果不一致，则继续循环，否则退出循环</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var5 <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> var5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>为什么CAS要比synchronized快</strong></p> <p>synchronized需要进行上下文切换，每一次线程进出Cpu就是一次上下文切换，而这一次切换大概需要3-5微秒，而Cpu执行一条执行大概只需要0.6纳秒，而CAS没有上下文切换的过程，那么效率就高。</p> <p><strong>ABA问题</strong></p> <p>CAS只会判断最终的对象是否与期望的一致，但不会判断在这期间对象是否有改变，当这期间对象发生了改变，就会产生ABA问题，即虽然判断对象是同一个，但是其中的属性发生了改变。</p> <p>解决方案：加版本号。</p> <p><strong>并发累加Long的三种方式</strong></p> <ol><li>加锁</li> <li>AtomicLong：CAS</li> <li>LongAdder：分段锁，线程数量特别多的时候比Atomic更有优势</li></ol> <p><strong>AtomicInteger</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2019</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t current data:&quot;</span> <span class="token operator">+</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t current data:&quot;</span> <span class="token operator">+</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
atomicInteger<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>AtomicReference</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> z3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;z3&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> l4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;l4&quot;</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>z3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>z3<span class="token punctuation">,</span> l4<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>z3<span class="token punctuation">,</span> l4<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token annotation punctuation">@ToString</span>
    <span class="token annotation punctuation">@AllArgsConstructor</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> username<span class="token punctuation">;</span>
        <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="锁的分类"><a href="#锁的分类" class="header-anchor">#</a> 锁的分类</h2> <h3 id="按性质分类"><a href="#按性质分类" class="header-anchor">#</a> 按性质分类</h3> <p><strong>公平锁</strong>：多个线程按照申请锁的顺序来获取锁。</p> <p><strong>非公平锁</strong>：多个线程获取锁的顺序并不是按照申请锁的顺序。</p> <p><strong>乐观锁</strong>：采用尝试更新，不断重新的方式更新数据。</p> <p><strong>悲观锁</strong>：对于同一个数据的并发操作，悲观锁采取加锁的形式。</p> <p><strong>独享锁</strong>：该锁一次只能被一个线程所持有。</p> <p><strong>共享锁</strong>：该锁可被多个线程所持有。</p> <p><strong>互斥锁</strong>：写锁。</p> <p><strong>读写锁</strong>：可以多人读，但只允许一人写。</p> <p><strong>可重入锁</strong>：在同一个线程的外层方法获取锁的时候，进入内层方法会自动获取锁。避免死锁。</p> <p><strong>对象锁</strong>：将sychronized放在普通同步方法中，sychronized同步监视器为普通对象</p> <p><strong>全局锁</strong>：将sychronized放在静态同步方法中，sychronized同步监视器为类对象</p> <h3 id="按照设计分类"><a href="#按照设计分类" class="header-anchor">#</a> 按照设计分类</h3> <p><strong>自旋锁</strong>：采用循环的方式去尝试获取锁。</p> <p><strong>自适应自旋锁</strong>：循环多次发现等待时间过长，切换为阻塞状态。</p> <p><strong>锁粗化</strong>：如一个方法内加了多个锁，JVM认为没必要，于是将其合并为一个锁。</p> <p><strong>锁消除</strong>：JVM认为有些代码块无需加锁，于是删除了那个锁。</p> <p><strong>偏向锁</strong>：一段同步代码一直被一个线程访问，该线程会自动获得锁。</p> <p><strong>轻量级锁</strong>：当锁是偏向锁的时候，被另外线程访问，其它线程会通过自旋的形式尝试获取锁。</p> <p><strong>重量级锁</strong>：当锁是轻量级锁的时候，另一个线程自旋到一定次数未得到锁则进入阻塞。</p> <p><strong>分段锁</strong>：将数据分为多段，每次只给一段加锁。</p> <h2 id="锁概念"><a href="#锁概念" class="header-anchor">#</a> 锁概念</h2> <h3 id="锁升级"><a href="#锁升级" class="header-anchor">#</a> 锁升级</h3> <ol><li>无锁：程序不会有锁竞争</li> <li>偏向锁：经常只有一个线程加锁，markword 记录线程ID</li> <li>自旋锁：有线程来参与锁的竞争，但是获取锁的冲突时间很短</li> <li>重量级锁：自旋10次以后，升为重量级锁 - 去OS申请锁资源</li></ol> <p>什么时候用自旋什么时候用重量级锁？</p> <p>执行时间长，线程多用重量级锁，否则用自旋。</p> <h3 id="锁发生改变"><a href="#锁发生改变" class="header-anchor">#</a> 锁发生改变</h3> <ol><li><p>程序中如果出现异常，默认情况下锁会被释放</p></li> <li><p>如果锁对象发生改变，锁就会失效。</p> <p>解决方案： 锁对象加 <code>final</code></p></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="juc和同步锁锁"><a href="#juc和同步锁锁" class="header-anchor">#</a> JUC和同步锁锁</h2> <h3 id="syncronized-实现细节"><a href="#syncronized-实现细节" class="header-anchor">#</a> Syncronized 实现细节</h3> <p>字节码层面：monitorenter monitorexit</p> <p>JVM层面：C  C++ 调用了操作系统提供的同步机制</p> <p>OS和硬件层面：x86是 <code>lock comxchg xxx</code>，lock是用来锁其它指令的</p> <h3 id="sychronized-and-lock"><a href="#sychronized-and-lock" class="header-anchor">#</a> Sychronized and Lock</h3> <ol><li>Sychronized：非公平，悲观，独享，互斥，可重入的重量级</li> <li>Lock
<ol><li>ReentrantLock：可公平，悲观，独享，互斥，可重入，重量级锁。</li> <li>ReentrantReadWriteLock：可公平，悲观，写独享，读共享，读写，可重入，重量级锁。</li></ol></li></ol> <p><strong>Sychronized 和 ReentrantLock 的区别</strong></p> <ol><li>synchronized是关键字，Lock是Api</li> <li>synchronized自动释放锁，Lock手动释放</li> <li>synchronized不可以中断，ReentrantLock可中断(调用interrupt方法)</li> <li>synchronized非公平锁，Lock两者皆可</li> <li>synchronized只能随机或全部唤醒，Lock可以使用Condition精确唤醒</li></ol> <p><strong>Sychronized 和 ReentrantLock 的使用场景</strong></p> <p>sychronized如果抢不到锁，就会一直等待</p> <p>reentrantLock有tryLock机制，如果等待超时可以放弃等待</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">// 3秒超时</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">// 业务逻辑</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 放弃等待后执行</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="readwritelock-stampedlock"><a href="#readwritelock-stampedlock" class="header-anchor">#</a> ReadWriteLock - StampedLock</h3> <p>ReadLock：读锁，读的时候其它读线程依然可以进入</p> <p>WriteLock，写锁，写的时候不允许其它线程进入</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> readWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> readLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> writeLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="countdownlatch"><a href="#countdownlatch" class="header-anchor">#</a> CountDownLatch</h3> <p>被减少到零之后才放行，否则阻塞等待。</p> <p>定义一个CountDownLatch，有初始值，使用await阻塞线程，当减少到0时消除阻塞，类似于join但是更灵活</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;解除门栓&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="cyclicbarrier"><a href="#cyclicbarrier" class="header-anchor">#</a> CyclicBarrier</h3> <p>先到的被阻塞，直到达到指定值时释放</p> <p>await到指定个线程之后，放行</p> <p>场景：某线程需等待其它线程执行完后才能执行</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放通行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t 线程已到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="phaser"><a href="#phaser" class="header-anchor">#</a> Phaser</h3> <p>CyclicBarrier升级版，使用arriveAndAwaitAdvance到达一个阶段的时候等待其它线程完成再向后执行</p> <h3 id="semaphore"><a href="#semaphore" class="header-anchor">#</a> Semaphore</h3> <p>多共享资源的互斥使用，并发线程数的控制。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 在多个线程并发访问时，最多只有3个线程可以同时运行</span>
<span class="token comment">// acquire:总量-1</span>
<span class="token comment">// release:总量+1</span>
<span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="exchanger"><a href="#exchanger" class="header-anchor">#</a> Exchanger</h3> <p>两个线程间交换数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 执行exchange()时阻塞线程</span>
<span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="线程等待和唤醒"><a href="#线程等待和唤醒" class="header-anchor">#</a> 线程等待和唤醒</h2> <h3 id="object-wait-notify"><a href="#object-wait-notify" class="header-anchor">#</a> Object: wait, notify</h3> <ol><li>都需要在同步代码块中执行(synchronized)</li> <li>先wait再notify，等待中的线程才会被唤醒，否则无法唤醒</li> <li>notify是随机唤醒一个线程</li> <li>notify不释放锁，需要等待线程执行完或者线程中wait()才释放</li> <li>notifyAll将所有线程唤醒，去争抢锁，但抢到锁的依旧只有一个线程</li></ol> <h3 id="condition-await-signal"><a href="#condition-await-signal" class="header-anchor">#</a> Condition: await, signal</h3> <ol><li>都需要在同步代码块中执行</li> <li>先await再signal，等待中的线程才会被唤醒，否则无法唤醒</li> <li>可以精确的指定哪些线程被唤醒，即使用不同的condition加锁即可，condition的本质就是不同的等待队列</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Condition</span> condition1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Condition</span> condition2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="locksupport-pack-unpack"><a href="#locksupport-pack-unpack" class="header-anchor">#</a> LockSupport: pack, unpack</h3> <p>线程阻塞工具类，可以让线程在任意位置阻塞，阻塞后也有对应的唤醒方法，底层调用Unsafe的native方法</p> <p>线程阻塞需要消耗Permit，Permit最多存在1个</p> <p>当调用park方法时</p> <ul><li>如果有凭证，直接消耗掉这个凭证然后正常退出</li> <li>如果无凭证，就阻塞等待凭证可用</li></ul> <p>当调用unpark方法时</p> <ul><li>增加一个凭证，但凭证最多有1个</li></ul> <h2 id="aqs-abstractqueuedsynchronizer"><a href="#aqs-abstractqueuedsynchronizer" class="header-anchor">#</a> AQS (AbstractQueuedSynchronizer)</h2> <p>概念：是用来构建锁或者其它同步组件的抽象父类</p> <p><strong>CAS + volatile state + 双端队列</strong></p> <p>CAS：在往队列末端加线程的时候使用的是CAS</p> <p>volatile：state变量用volatile修饰保证线程之间可见</p> <p>state：根据子类的具体实现来分配，如ReentrantLock加锁,是1，不加锁是0；CountDownLatch设置为5，state就是5</p> <p>双端队列：CLH变种的双端队列，Node中存放的是线程</p> <p><strong>公平锁和非公平锁</strong></p> <ol><li>非公平锁在调用 lock 后，首先就会调用 CAS 进行一次抢锁，如果这个时候恰巧锁没有被占用，那么直接就获取到锁返回了。</li> <li>非公平锁在 CAS 失败后，和公平锁一样都会进入到 tryAcquire 方法，在 tryAcquire 方法中，如果发现锁这个时候被释放了，非公平锁会直接 CAS 抢锁，但是公平锁会判断等待队列是否有线程处于等待状态，如果有则不去抢锁，乖乖排到后面。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 公平锁会通过 hasQueuedPredecessors 方法判断队列前是否有元素 有就排队 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 非公平锁上来直接就抢锁 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20201218203120948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>源码说明</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 第一个线程抢到锁</span>
    <span class="token keyword">else</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 第二个线程及后续线程抢占</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>		<span class="token comment">// 尝试抢占，抢占成功返回true不进入队列</span>
        <span class="token comment">// acquireQueued 尝试获取锁，若不成功则用LockSupport.park阻塞，直到被唤醒</span>
        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>	
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Try the fast path of enq; backup to full enq on failure</span>
    <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    <span class="token comment">// 第二次以后进入只需将Node加入队列末尾即可</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 第一次进入队列会先初始化，即生成一个空的头节点</span>
    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 如果前置节点是头节点，那么第二个节点会尝试获得锁</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>JDK9使用VarHandle：普通的原子操作，比反射快，直接操作二进制码</p> <h2 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h2> <blockquote><p>线程独享的Map</p></blockquote> <p><strong>ThreadLocalMap中的Entry是弱引用</strong></p> <ol><li>若是强引用，即使tl == null，但key的引用依然指向ThreadLocal对象，所以有内存泄露，而使用弱引用则不会。</li> <li>但还是有内存泄露的存在，ThreadLocalMap 是 Thread 的一个属性，生命周期跟 Thread 一致，当ThreadLocal被回收，key的值变成null，则导致整个value再也无法被访问到，因此依然存在内存泄露。所以ThreadLocal不用了需要调用 <code>remove()</code>回收</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">M</span><span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210114221056228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/18/2021, 9:53:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/keith-book/Java/Java多线程.html" class="prev">
        Java 多线程
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/keith-book/assets/js/app.7ae60ab7.js" defer></script><script src="/keith-book/assets/js/2.044773f5.js" defer></script><script src="/keith-book/assets/js/11.a6a3b5c9.js" defer></script>
  </body>
</html>
